<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- TABLE : CT_DEBR_B [커뮤니티 토론실 기본] -->
<mapper namespace="com.innobiz.orange.web.ct.dao.CtDebrBDao">

	<resultMap id="ctDebrBMap" type="CtDebrBVo">
	    
	    <id property="compId" column="COMP_ID" /><!--회사 ID-->
	    <id property="ctId" column="CT_ID" /><!--커뮤니티 ID-->
	    <id property="debrId" column="DEBR_ID" /><!--토론실 ID-->
	    
	    <result property="ctFncId" column="CT_FNC_ID" /><!--커뮤니티 기능 ID-->
	    <result property="ctFncOrdr" column="CT_FNC_ORDR" /><!--  커뮤니티 기능 순서 -->
	    <result property="subj" column="SUBJ" /><!--제목-->
	    <result property="estbItnt" column="ESTB_ITNT" /><!--개설 취지-->
	    <result property="sitn" column="SITN" /><!--회기-->
	    <result property="finYn" column="FIN_YN" /><!--마감여부-->
	    <result property="regDt" column="REG_DT" /><!--등록일자-->
	    <result property="modDt" column="MOD_DT" /><!--수정일자-->
	    <result property="regrUid" column="REGR_UID" /><!--등록자 UID-->
	    <result property="modrUid" column="MODR_UID" /><!--수정자 UID-->
	    <result property="ctFncLocStep" column="CT_FNC_LOC_STEP" /><!-- 커뮤니티 기능 위치 단계 -->
	    <result property="ctFncUid" column="CT_FNC_UID" /><!-- 커뮤니티 기능 UID -->
	    <result property="ctFncPid" column="CT_FNC_PID" /><!-- 커뮤니티 기능 부모ID -->
	    <result property="langTyp" column="LANG_TYP" /><!-- 사용자 언어타입 -->
	    <result property="regrNm" column="REGR_NM" /><!-- 등록자명 -->
	    <result property="modrNm" column="MODR_NM" /><!-- 수정자명 -->
	    <result property="opinCnt" column="OPIN_CNT" /><!-- 의견수 -->
	    
	     <!-- 커뮤니티 자료검색  -->
	    <result property="fncNm" column="FNC_NM" /><!-- 기능명 -->
	    <result property="strtDt" column="START_DT" /><!--시작 일시-->
		<result property="endDt" column="END_DT" /><!--종료 일시-->
		<result property="ctFncUrl" column="CT_FNC_URL" /><!--커뮤니티 기능 URL -->
		<result property="relTblSubj" column="REL_TBL_SUBJ" /><!--관계테이블명 -->
		<result property="ctNm" column="CT_NM" /><!--커뮤니티 명-->
		<result property="mastNm" column="MAST_NM" /><!-- 마스터명 -->
		<result property="mastUid" column="MAST_UID" /><!-- 마스터UID -->
	</resultMap>
	
	<!-- 조회조건 -->
	<sql id="selectCtDebrBWhere">
	    <if test="'masterOpt'.equals(schCat) and schWord != null and schWord != ''">
		       INNER JOIN CT_ESTB_B CEB_T ON CDB_T.CT_ID = CEB_T.CT_ID 
		        INNER JOIN OR_USER_B OUB ON CEB_T.MAST_UID = OUB.USER_UID
		         		AND OUB.USER_NM LIKE '%'||#{schWord, jdbcType=VARCHAR}||'%'
		</if>
		<where>
		    <if test="compId != null and compId != ''"> AND CDB_T.COMP_ID = #{compId, jdbcType=VARCHAR}</if>
   		    <if test="ctId != null and ctId != ''"> AND CDB_T.CT_ID = #{ctId, jdbcType=VARCHAR}</if>
   		    <if test="debrId != null and debrId != ''"> AND CDB_T.DEBR_ID = #{debrId, jdbcType=VARCHAR}</if>
   		    <if test="schCat == 'TOPC' and schWord != null and schWord != ''"> AND CDB_T.SUBJ like '%' || #{schWord, jdbcType=VARCHAR} || '%'</if>
			<if test="schCat == 'ITNT' and schWord != null and schWord != ''"> AND CDB_T.ESTB_ITNT like '%' || #{schWord, jdbcType=VARCHAR} || '%'</if>
			<if test="schCat == 'REGR_NM' and schWord != null and schWord != ''"> AND R.RESC_VA like '%' || #{schWord, jdbcType=VARCHAR} || '%'</if>
			<!-- 날짜로 커뮤니티 자료검색  -->
			<if test="strtDt != null and strtDt != '' and  endDt != null and endDt != ''">
				AND TO_CHAR(CDB_T.REG_DT, 'YYYY-MM-DD') BETWEEN  #{strtDt, jdbcType=VARCHAR} AND #{endDt, jdbcType=VARCHAR}
			</if>
			<if test="ctIdList != null">
	   			<![CDATA[ AND CT_ID IN ]]>
	   				 <foreach collection="ctIdList" item="item" index="index" separator="," open="(" close=")">
			            	#{item, jdbcType=VARCHAR}
			        </foreach>	   			
	   		</if>
			<if test="'communityOpt'.equals(schCat) and schWord != null and schWord != ''">
			        AND (
							SELECT RESC_VA 
							FROM CT_RESC_B
							WHERE RESC_ID = (
												SELECT CT_SUBJ_RESC 
												FROM CT_ESTB_B
												WHERE CT_ID = CDB_T.CT_ID
												AND LANG_TYP_CD = #{langTyp, jdbcType=VARCHAR}
											)
			      		) LIKE '%'||#{schWord, jdbcType=VARCHAR}||'%'
			</if>
		</where>
	</sql>
	
	<!-- 목록조회 -->
	<select id="selectCtDebrB" resultMap="ctDebrBMap" parameterType="CtDebrBVo" >
		/* com.innobiz.orange.web.ct.dao.CtDebrBDao.selectCtDebrB */
		
		<if test="pageNo != null and pageRowCnt != null">
		SELECT * FROM (
		</if>
		SELECT
		
		<trim prefix="" suffix="" suffixOverrides=",">
			<if test="pageNo != null and pageRowCnt != null">
			* FROM (SELECT N.*, ROWNUM RNUM FROM (SELECT
			</if>
			CDB_T.COMP_ID, CDB_T.CT_ID, CDB_T.DEBR_ID,
			CDB_T.CT_FNC_ID, CDB_T.CT_FNC_ORDR, CDB_T.SUBJ,
			CDB_T.ESTB_ITNT, CDB_T.SITN, 
			CDB_T.REG_DT, CDB_T.MOD_DT, CDB_T.REGR_UID,
			CDB_T.MODR_UID, CDB_T.CT_FNC_LOC_STEP, CDB_T.CT_FNC_UID,
			CDB_T.CT_FNC_PID,
			(
			 SELECT RESC_VA FROM CT_RESC_B
				WHERE LANG_TYP_CD = #{langTyp, jdbcType=VARCHAR}
				AND RESC_ID=(				
								SELECT CT_FNC_SUBJ_RESC_ID FROM CT_FNC_D
								WHERE CT_FNC_UID = CDB_T.CT_FNC_UID
							)
      		)FNC_NM,
      		(
      			SELECT URL 
				FROM CT_FNC_MNG_B
				WHERE CDB_T.CT_FNC_ID = CT_FNC_ID
				
			)CT_FNC_URL,
		   (
      			SELECT REL_TBL_SUBJ 
				FROM CT_FNC_MNG_B
				WHERE CDB_T.CT_FNC_ID = CT_FNC_ID
			)REL_TBL_SUBJ,
			(SELECT RESC_VA FROM OR_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM OR_USER_B WHERE USER_UID = CDB_T.REGR_UID) AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR}, 'ko')) REGR_NM,
			(SELECT RESC_VA FROM OR_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM OR_USER_B WHERE USER_UID = CDB_T.MODR_UID) AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR}, 'ko')) MODR_NM,
			(
				SELECT COUNT(*) 
					FROM CT_DEBR_OPIN_D
					WHERE DEBR_ID = CDB_T.DEBR_ID
			)OPIN_CNT,
			(
				SELECT RESC_VA 
				FROM CT_RESC_B
				WHERE RESC_ID = (SELECT CT_SUBJ_RESC FROM CT_ESTB_B WHERE CT_ID = CDB_T.CT_ID)
				AND LANG_TYP_CD = #{langTyp, jdbcType=VARCHAR}
      		) CT_NM,
      		(SELECT RESC_VA
		      	FROM OR_RESC_B
		      	WHERE RESC_ID = (
		      						SELECT RESC_ID
		      						FROM OR_USER_B
		      						WHERE USER_UID = (
		      											SELECT MAST_UID
														FROM CT_ESTB_B
														WHERE CDB_T.CT_ID = CT_ID
		      						
		      										)
		      					)
				AND LANG_TYP_CD = #{queryLang, jdbcType=VARCHAR}
		    )MAST_NM,
		    (
				SELECT MAST_UID
				FROM CT_ESTB_B
				WHERE CDB_T.CT_ID = CT_ID
			)MAST_UID,
			
		<![CDATA[CASE WHEN CDB_T.FIN_YN = 'Y' THEN 'Y' WHEN CDB_T.FIN_YN = 'N' THEN (CASE WHEN SYSDATE <= (CDB_T.REG_DT + CDB_T.SITN * 7) THEN 'N' ELSE 'Y' END) ELSE 'N' END FIN_YN,]]>

		</trim>
		FROM CT_DEBR_B CDB_T
		<if test="schCat == 'REGR_NM' and schWord != null and schWord != ''">
			LEFT JOIN OR_USER_B U ON CDB_T.REGR_UID = U.USER_UID
			LEFT JOIN OR_RESC_B R ON U.RESC_ID = R.RESC_ID AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR}, 'ko')
		</if>
		<include refid="selectCtDebrBWhere"/>
		<if test="orderBy != null">ORDER BY ${orderBy}</if>
		<if test="orderBy == null">ORDER BY CDB_T.DEBR_ID</if>
		<if test="pageNo != null and pageRowCnt != null">
		<![CDATA[) N WHERE ROWNUM <= #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}) WHERE RNUM > (#{pageNo, jdbcType=NUMERIC} - 1) * #{pageRowCnt, jdbcType=NUMERIC}]]> ) M
		</if>
	</select>
	

	<!-- 목록조회 건수-->
	<select id="countCtDebrB" resultType="Integer" parameterType="CtDebrBVo" >
		/* com.innobiz.orange.web.ct.dao.CtDebrBDao.countCtDebrB */
		SELECT COUNT(*) CNT
		FROM CT_DEBR_B CDB_T
		<if test="schCat == 'REGR_NM' and schWord != null and schWord != ''">
			LEFT JOIN OR_USER_B U ON CDB_T.REGR_UID = U.USER_UID
			LEFT JOIN OR_RESC_B R ON U.RESC_ID = R.RESC_ID AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR}, 'ko')
		</if>
		<include refid="selectCtDebrBWhere"/>
	</select>
	
	<!-- 등록 저장 -->
	<insert id="insertCtDebrB" parameterType="CtDebrBVo" >
		/* com.innobiz.orange.web.ct.dao.CtDebrBDao.insertCtDebrB */
		INSERT INTO CT_DEBR_B
		<trim prefix="(" suffix=")" suffixOverrides=",">
			COMP_ID, CT_ID, DEBR_ID,
			CT_FNC_ID, CT_FNC_ORDR, SUBJ,
			ESTB_ITNT, SITN, FIN_YN,
			REGR_UID, REG_DT, MOD_DT, 
			MODR_UID, CT_FNC_LOC_STEP, CT_FNC_UID,
			CT_FNC_PID,

		</trim>
		<trim prefix="VALUES (" suffix=")" suffixOverrides="," >
			#{compId, jdbcType=VARCHAR}, #{ctId, jdbcType=VARCHAR}, #{debrId, jdbcType=VARCHAR},
			#{ctFncId, jdbcType=VARCHAR}, #{ctFncOrdr, jdbcType=NUMERIC}, #{subj, jdbcType=NVARCHAR},
			#{estbItnt, jdbcType=NVARCHAR}, #{sitn, jdbcType=NUMERIC}, #{finYn, jdbcType=VARCHAR},
			<if test="regrUid != null">#{regrUid, jdbcType=VARCHAR},</if><if test="regrUid == null">#{modrUid, jdbcType=VARCHAR},</if>
			<if test="regDt == 'sysdate'">SYSDATE,</if><if test="regDt == null or regDt == ''"><if test="modDt == 'sysdate'">SYSDATE,</if><if test="modDt != 'sysdate'">NULL,</if></if>
			<if test="regDt != null and regDt != '' and regDt != 'sysdate'">TO_DATE(#{regDt, jdbcType=VARCHAR}, 'YYYY-MM-DD HH24:MI:SS'),</if> 
			<if test="modDt == 'sysdate'">SYSDATE,</if><if test="modDt == null or modDt == ''">NULL,</if>
			<if test="modDt != null and modDt != '' and modDt != 'sysdate'">TO_DATE(#{modDt, jdbcType=VARCHAR}, 'YYYY-MM-DD HH24:MI:SS'),</if>
			#{modrUid, jdbcType=VARCHAR}, #{ctFncLocStep, jdbcType=VARCHAR}, #{ctFncUid, jdbcType=VARCHAR}, 
			#{ctFncPid, jdbcType=VARCHAR}, 
		</trim>
	</insert>
	
	<!-- 수정 -->
	<update id="updateCtDebrB" parameterType="CtDebrBVo" >
		/* com.innobiz.orange.web.ct.dao.CtDebrBDao.updateCtDebrB */
		UPDATE CT_DEBR_B
		<set>
			<if test="ctFncId != null"> CT_FNC_ID = #{ctFncId, jdbcType=VARCHAR},</if>
			<if test="ctFncOrdr != null"> CT_FNC_ORDR = #{ctFncOrdr, jdbcType=NUMERIC},</if>
			<if test="subj != null"> SUBJ = #{subj, jdbcType=NVARCHAR},</if>
			<if test="estbItnt != null"> ESTB_ITNT = #{estbItnt, jdbcType=NVARCHAR},</if>
			<if test="sitn != null"> SITN = #{sitn, jdbcType=NUMERIC},</if>
			<if test="finYn != null"> FIN_YN = #{finYn, jdbcType=VARCHAR},</if>
			<if test="modDt != null"> MOD_DT = TO_DATE(#{modDt, jdbcType=VARCHAR}, 'YYYY-MM-DD HH24:MI:SS'),</if>
			<if test="modrUid != null"> MODR_UID = #{modrUid, jdbcType=VARCHAR},</if>
			<if test="ctFncLocStep != null"> CT_FNC_LOC_STEP = #{ctFncLocStep, jdbcType=VARCHAR},</if>
			<if test="ctFncUid != null"> CT_FNC_UID = #{ctFncUid, jdbcType=VARCHAR},</if>
			<if test="ctFncPid != null"> CT_FNC_PID = #{ctFncPid, jdbcType=VARCHAR},</if>
			
		</set>
		<where>
			<if test="compId != null and compId != ''"> AND COMP_ID = #{compId, jdbcType=VARCHAR}</if>
   		    <if test="ctId != null and ctId != ''"> AND CT_ID = #{ctId, jdbcType=VARCHAR}</if>
   		    <if test="debrId != null and debrId != ''"> AND DEBR_ID = #{debrId, jdbcType=VARCHAR}</if>
		</where>
	</update>

	<!-- 삭제 -->
	<delete id="deleteCtDebrB" parameterType="CtDebrBVo" >
		/* com.innobiz.orange.web.ct.dao.CtDebrBDao.deleteCtDebrB */
		DELETE FROM CT_DEBR_B
		<where>
		   <if test="compId != null and compId != ''"> AND COMP_ID = #{compId, jdbcType=VARCHAR}</if>
   		   <if test="ctId != null and ctId != ''"> AND CT_ID = #{ctId, jdbcType=VARCHAR}</if>
   		   <if test="debrId != null and debrId != ''"> AND DEBR_ID = #{debrId, jdbcType=VARCHAR}</if>
		</where>
	</delete>

</mapper>