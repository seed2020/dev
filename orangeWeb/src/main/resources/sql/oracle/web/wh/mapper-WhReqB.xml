<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- TABLE : WH_REQ_B[요청기본] -->
<mapper namespace="com.innobiz.orange.web.wh.dao.WhReqBDao">

	<resultMap id="whReqBMap" type="WhReqBVo">
		<id property="reqNo" column="REQ_NO" /><!-- 요청번호 -->
		<result property="compId" column="COMP_ID" /><!-- 회사ID -->
		<result property="deptId" column="DEPT_ID" /><!-- 부서ID -->
		<result property="deptNm" column="DEPT_NM" /><!-- 부서명 -->
		<result property="docNo" column="DOC_NO" /><!-- 문서번호 -->
		<result property="subj" column="SUBJ" /><!-- 제목 -->
		<result property="cont" column="CONT" /><!-- 내용 -->
		<result property="reqDt" column="REQ_DT" /><!-- 요청일 -->
		<result property="cmplPdt" column="CMPL_PDT" /><!-- 완료희망일 -->
		<result property="progrmId" column="PROGRM_ID" /><!-- 프로그램ID -->
		<result property="progrmNm" column="PROGRM_NM" /><!-- 프로그램명 -->
		<result property="writtenReqYn" column="WRITTEN_REQ_YN" /><!-- 의뢰서여부 -->		
		<result property="writtenReqNo" column="WRITTEN_REQ_NO" /><!-- 의뢰서번호 -->
		<result property="uploadNo" column="UPLOAD_NO" /><!-- 업로드번호 -->
		<result property="regrNm" column="REGR_NM" /><!-- 등록자명 -->
		<result property="regrUid" column="REGR_UID" /><!-- 등록자UID -->
		<result property="regDt" column="REG_DT" /><!-- 등록일시 -->
		<result property="modrUid" column="MODR_UID" /><!-- 수정자 -->
		<result property="modDt" column="MOD_DT" /><!-- 수정일시 -->
		<result property="mdId" column="MD_ID" /><!-- 모듈ID-->
		<result property="statCd" column="STAT_CD" /><!-- 상태코드 -->
		<result property="pichUid" column="PICH_UID" /><!-- 담당자UID -->
		<result property="pichNm" column="PICH_NM" /><!-- 담당자명 -->
		<result property="recvUid" column="RECV_UID" /><!-- 접수자UID -->
		<result property="recvNm" column="RECV_NM" /><!-- 접수자명 -->
		<result property="recvDt" column="RECV_DT" /><!-- 접수일시 -->
		<result property="mdNm" column="MD_NM" /><!-- 모듈명 -->
		<result property="catNm" column="CAT_NM" /><!-- 처리유형명 -->		
		<result property="cmplDueDt" column="CMPL_DUE_DT" /><!-- 완료예정일 -->
		<result property="cmplDt" column="CMPL_DT" /><!-- 완료일 -->
		<result property="evalYn" column="EVAL_YN" /><!-- 평가여부 -->
		<result property="hdlrUid" column="HDLR_UID" /><!-- 처리담당자UID -->
		<result property="hdlrNm" column="HDLR_NM" /><!-- 처리담당자명 -->
		<result property="devHourVa" column="DEV_HOUR_VA" /><!-- 공수 -->
		<result property="hdlCont" column="HDL_CONT" /><!-- 완료사항 -->
	</resultMap>
	
	<resultMap id="dashBrdMap" type="WhReqBVo">
		<result property="statCd" column="STAT_CD" /><!-- 상태코드 -->
		<result property="totalCnt" column="TOTAL_CNT" /><!-- 전체건수 -->
	</resultMap>
	
	<resultMap id="evalMap" type="WhReqBVo">
		<result property="evalNm" column="EVAL_NM" /><!-- 평가명 -->
		<result property="totalCnt" column="TOTAL_CNT" /><!-- 전체건수 -->
	</resultMap>
	
	<!-- 조회조건 -->
	<sql id="selectWhReqBWhere">
		<where>
			<if test="reqNo != null and reqNo !=''"> AND T.REQ_NO = #{reqNo, jdbcType=VARCHAR}</if>
			<if test="compId != null and compId !=''"> AND T.COMP_ID = #{compId, jdbcType=VARCHAR}</if>
			<if test="compIdList != null"> AND T.COMP_ID IN <foreach item="item" collection="compIdList" open="(" separator="," close=")">#{item, jdbcType=VARCHAR}</foreach></if>
			<if test="deptId != null and deptId !=''"> AND T.DEPT_ID = #{deptId, jdbcType=VARCHAR}</if>
			<if test="docNo != null and docNo !=''"> AND T.DOC_NO LIKE '%' || #{docNo, jdbcType=VARCHAR} || '%'</if>
			<if test="regrUid != null and regrUid !=''"> AND T.REGR_UID = #{regrUid, jdbcType=VARCHAR}</if>
			<if test="withDtl">
				<if test='schOptCat != null and schOptWord != ""'>
					<if test='"regrUid".equals(schOptCat)'> AND T.REGR_UID = #{schOptWord, jdbcType=VARCHAR}</if>
					<if test='"pichUid".equals(schOptCat)'> AND O.PICH_UID = #{schOptWord, jdbcType=VARCHAR}</if>
					<if test='"recvUid".equals(schOptCat)'> AND O.RECV_UID = #{schOptWord, jdbcType=VARCHAR}</if>
					<if test='"hdlrUid".equals(schOptCat)'> AND O.HDLR_UID = #{schOptWord, jdbcType=VARCHAR}</if>
				</if>
				<if test="mdId != null and mdId !=''"> AND O.MD_ID = #{mdId, jdbcType=VARCHAR}</if>
				<if test="statCd != null and statCd !=''"> AND O.STAT_CD = #{statCd, jdbcType=VARCHAR}</if>
				<if test="pichUid != null and pichUid !=''"> AND O.PICH_UID = #{pichUid, jdbcType=VARCHAR}</if>
				<if test="recvUid != null and recvUid !=''"> AND O.RECV_UID = #{recvUid, jdbcType=VARCHAR}</if>				
				<if test="hdlrUid != null and hdlrUid !=''"> AND O.HDLR_UID = #{hdlrUid, jdbcType=VARCHAR}</if>
				<if test="catNo != null and catNo !=''"> AND O.CAT_NO = #{catNo, jdbcType=VARCHAR}</if>
				<if test="durCat == 'reqDt' and durStrtDt != null and durStrtDt != ''"><![CDATA[ AND T.REQ_DT >= TO_DATE(#{durStrtDt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS')]]></if>
				<if test="durCat == 'reqDt' and durEndDt != null and durEndDt != ''"><![CDATA[ AND T.REQ_DT <= TO_DATE(#{durEndDt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS')]]></if>
				<if test="durCat == 'recvDt' and durStrtDt != null and durStrtDt != ''"><![CDATA[ AND O.RECV_DT >= TO_DATE(#{durStrtDt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS')]]></if>
				<if test="durCat == 'recvDt' and durEndDt != null and durEndDt != ''"><![CDATA[ AND O.RECV_DT <= TO_DATE(#{durEndDt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS')]]></if>
				<if test="durCat == 'cmplDt' and durStrtDt != null and durStrtDt != ''"><![CDATA[ AND O.CMPL_DT >= TO_DATE(#{durStrtDt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS')]]></if>
				<if test="durCat == 'cmplDt' and durEndDt != null and durEndDt != ''"><![CDATA[ AND O.CMPL_DT <= TO_DATE(#{durEndDt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS')]]></if>
				<if test="evalYn != null and evalYn !=''"> AND O.EVAl_YN = #{evalYn, jdbcType=VARCHAR}</if>
				<if test="statCdList != null"> AND O.STAT_CD IN ( <foreach collection="statCdList" item="item" index="index" separator=",">#{item, jdbcType=VARCHAR}</foreach> )</if>
			</if>
			<if test="withRel">
				<if test="relNo != null and relNo !=''"> AND R.REQ_NO = #{relNo, jdbcType=VARCHAR}</if>
			</if>
			<if test='schCat != null and schWord != ""'>
				<if test='"subj".equals(schCat)'> AND T.SUBJ LIKE '%' || #{schWord, jdbcType=VARCHAR} || '%'</if>
				<if test='"cont".equals(schCat)'> AND T.CONT LIKE '%' || #{schWord, jdbcType=VARCHAR} || '%'</if>
				<if test='"docNo".equals(schCat)'> AND T.DOC_NO LIKE '%' || #{schWord, jdbcType=VARCHAR} || '%'</if>
				<if test='"reqrNm".equals(schCat)'> AND S.RESC_VA LIKE '%' || #{schWord, jdbcType=VARCHAR} || '%'</if>
			</if>
			<if test='schCat == null or schWord == ""'>
				<if test="subj != null and subj !=''"> AND T.SUBJ LIKE '%' || #{subj, jdbcType=VARCHAR} || '%'</if>
				<if test="cont != null and cont !=''"> AND T.CONT LIKE '%' || #{cont, jdbcType=VARCHAR} || '%'</if>
				<if test="docNo != null and docNo !=''"> AND T.DOC_NO LIKE '%' || #{docNo, jdbcType=VARCHAR} || '%'</if>
			</if>
			<if test="withCmpl">
				<if test='schCat != null and schWord != ""'>
					<if test='"hdlCont".equals(schCat)'> AND C.HDL_CONT LIKE '%' || #{schWord, jdbcType=VARCHAR} || '%'</if>
				</if>
				<if test='schCat == null or schWord == ""'>
					<if test="hdlCont != null and hdlCont !=''"> AND C.HDL_CONT LIKE '%' || #{hdlCont, jdbcType=VARCHAR} || '%'</if>
				</if>
			</if>
			<if test="whereSqllet != null and whereSqllet != ''"> ${whereSqllet}</if>
		</where>
	</sql>
	<!-- 조인 조건 -->
	<sql id="selectWhReqBJoin">
		<if test="schCat == 'reqrNm' and schWord != null and schWord != ''">
			INNER JOIN OR_USER_B U ON T.REGR_UID = U.USER_UID
			INNER JOIN OR_RESC_B S ON U.RESC_ID = S.RESC_ID AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR}, 'ko')
		</if>
	</sql>
	
	<!-- 목록조회 -->
	<select id="selectWhReqB" resultMap="whReqBMap" parameterType="WhReqBVo" >
		/* com.innobiz.orange.web.wh.dao.WhReqBDao.selectWhReqB */
		<if test="pageNo != null and pageRowCnt != null">
		SELECT * FROM (
		</if>
		SELECT
		<trim prefix="" suffix="" suffixOverrides=",">
			<if test="pageNo != null and pageRowCnt != null">
			* FROM (SELECT N.*, ROWNUM RNUM FROM (SELECT
			</if>
			T.REQ_NO,
	        T.COMP_ID,
	        T.DEPT_ID,
	        (SELECT RESC_VA FROM OR_RESC_B WHERE RESC_ID = (SELECT DEPT_RESC_ID FROM OR_ORG_B WHERE ORG_ID = T.DEPT_ID) AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR},'ko')) DEPT_NM,
	        T.DOC_NO,
	        T.SUBJ,
	        <if test="withLob">T.CONT,</if>
	        T.REQ_DT,
	        T.CMPL_PDT,
	        T.PROGRM_ID,
	        T.PROGRM_NM,
	        T.WRITTEN_REQ_YN,
	        T.WRITTEN_REQ_NO,
	        T.UPLOAD_NO,
	        (SELECT RESC_VA FROM OR_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM OR_USER_B WHERE USER_UID = T.REGR_UID) AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR}, 'ko')) REGR_NM,
	        T.REGR_UID,
	        T.REG_DT,
	        T.MODR_UID,
	        T.MOD_DT,
	        <if test="withDtl">
	        O.MD_ID,
	        (SELECT RESC_VA FROM WH_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM WH_MD_B WHERE MD_ID = O.MD_ID) AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR},'ko')) AS MD_NM,
	        O.STAT_CD,
	        O.PICH_UID,
	        O.RECV_UID,
	        (SELECT RESC_VA FROM OR_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM OR_USER_B WHERE USER_UID = O.RECV_UID) AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR}, 'ko')) RECV_NM,
	        O.RECV_DT,
	        (SELECT RESC_VA FROM OR_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM OR_USER_B WHERE USER_UID = O.PICH_UID) AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR}, 'ko')) PICH_NM,
	        (SELECT RESC_VA FROM WH_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM WH_CAT_GRP_L WHERE CAT_NO = O.CAT_NO) AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR},'ko')) AS CAT_NM,
	        O.CMPL_DUE_DT,
	        O.CMPL_DT,
	        O.EVAL_YN,
	        O.HDLR_UID,
	        (SELECT RESC_VA FROM OR_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM OR_USER_B WHERE USER_UID = O.HDLR_UID) AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR}, 'ko')) HDLR_NM,
	        </if>
	         <if test="withCmpl">	        
	        C.DEV_HOUR_VA,
	        C.HDL_CONT,
	        </if>
		</trim>
		FROM WH_REQ_B T <if test="withDtl"> INNER JOIN WH_REQ_ONGD_D O ON T.REQ_NO = O.REQ_NO </if>
									<if test="withCmpl">LEFT OUTER JOIN WH_REQ_CMPL_D C ON T.REQ_NO = C.REQ_NO</if>
									<if test="withRel">INNER JOIN WH_REQ_REL_D R ON T.REQ_NO = R.REL_NO</if>
		<include refid="selectWhReqBJoin" />
		<include refid="selectWhReqBWhere"/>
		<if test="orderBy != null">ORDER BY ${orderBy}</if>
		<if test="orderBy == null">ORDER BY T.REG_DT</if>
		<if test="pageNo != null and pageRowCnt != null">
		<![CDATA[) N WHERE ROWNUM <= #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}) WHERE RNUM > (#{pageNo, jdbcType=NUMERIC} - 1) * #{pageRowCnt, jdbcType=NUMERIC}]]> ) M
		</if>
	</select>
	
	<!-- 목록조회 건수-->
	<select id="countWhReqB" resultType="Integer" parameterType="WhReqBVo" >
		/* com.innobiz.orange.web.wh.dao.WhReqBDao.countWhReqB */
		SELECT COUNT(*) CNT
		FROM WH_REQ_B T <if test="withDtl"> INNER JOIN WH_REQ_ONGD_D O ON T.REQ_NO = O.REQ_NO </if>
									<if test="withCmpl">LEFT OUTER JOIN WH_REQ_CMPL_D C ON T.REQ_NO = C.REQ_NO</if>
									<if test="withRel">INNER JOIN WH_REQ_REL_D R ON T.REQ_NO = R.REL_NO</if>		
		<include refid="selectWhReqBJoin" />
		<include refid="selectWhReqBWhere"/>
	</select>
	
	<!-- 등록 저장 -->
	<insert id="insertWhReqB" parameterType="WhReqBVo" >
		/* com.innobiz.orange.web.wh.dao.WhReqBDao.insertWhReqB */
		INSERT INTO WH_REQ_B
		<trim prefix="(" suffix=")" suffixOverrides=",">
			REQ_NO,
	        COMP_ID,
	        DEPT_ID,
	        DOC_NO,
	        SUBJ,
	        CONT,
	        REQ_DT,
	        CMPL_PDT,
	        PROGRM_ID,
	        PROGRM_NM,
	        WRITTEN_REQ_YN,
	        WRITTEN_REQ_NO,
	        UPLOAD_NO,
	        REGR_UID,
	        REG_DT,
	        MODR_UID,
	        MOD_DT,
		</trim>
		<trim prefix="VALUES (" suffix=")" suffixOverrides="," >
			#{reqNo, jdbcType=INTEGER},
			#{compId, jdbcType=VARCHAR},
			#{deptId, jdbcType=VARCHAR},
			#{docNo, jdbcType=NVARCHAR},
			#{subj, jdbcType=VARCHAR},
			#{cont, jdbcType=VARCHAR},
			<if test="reqDt == 'sysdate'">SYSDATE,</if><if test="reqDt == null or reqDt == ''">NULL,</if>
			<if test="reqDt != null and reqDt != '' and reqDt != 'sysdate'">TO_DATE(#{reqDt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS'),</if>
			<if test="cmplPdt == 'sysdate'">SYSDATE,</if><if test="cmplPdt == null or cmplPdt == ''">NULL,</if>
			<if test="cmplPdt != null and cmplPdt != '' and cmplPdt != 'sysdate'">TO_DATE(#{cmplPdt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS'),</if>
			#{progrmId, jdbcType=VARCHAR},
			#{progrmNm, jdbcType=VARCHAR},
			#{writtenReqYn, jdbcType=CHAR},
			#{writtenReqNo, jdbcType=VARCHAR},
			#{uploadNo, jdbcType=INTEGER},
			<if test="regrUid != null">#{regrUid, jdbcType=VARCHAR},</if><if test="regrUid == null">NULL,</if>
			<if test="regDt == 'sysdate'">SYSDATE,</if><if test="regDt == null or regDt == ''">NULL,</if>
			<if test="regDt != null and regDt != '' and regDt != 'sysdate'">TO_DATE(#{regDt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS'),</if>
			<if test="modrUid != null">#{modrUid, jdbcType=VARCHAR},</if><if test="modrUid == null">NULL,</if>
			<if test="modDt == 'sysdate'">SYSDATE,</if><if test="modDt == null or modDt == ''">NULL,</if>
			<if test="modDt != null and modDt != '' and modDt != 'sysdate'">TO_DATE(#{modDt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS'),</if>
		</trim>
	</insert>
	
	<!-- 수정 -->
	<update id="updateWhReqB" parameterType="WhReqBVo" >
		/* com.innobiz.orange.web.wh.dao.WhReqBDao.updateWhReqB */
		UPDATE WH_REQ_B
		<set>
			<if test="subj != null"> SUBJ = #{subj, jdbcType=NVARCHAR},</if>
			<if test="cont != null"> CONT = #{cont, jdbcType=NVARCHAR},</if>
			<if test="reqDt != null"> 
				<if test="reqDt == 'sysdate'"> REQ_DT = SYSDATE,</if>
				<if test="reqDt == ''"> REQ_DT = NULL,</if>
				<if test="reqDt != '' and reqDt != 'sysdate'"> REQ_DT = TO_DATE(#{reqDt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS'),</if>
			</if>	
			<if test="cmplPdt != null"> 
				<if test="cmplPdt == 'sysdate'"> CMPL_PDT = SYSDATE,</if>
				<if test="cmplPdt == ''"> CMPL_PDT = NULL,</if>
				<if test="cmplPdt != '' and cmplPdt != 'sysdate'"> CMPL_PDT = TO_DATE(#{cmplPdt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS'),</if>
			</if>	
			<if test="progrmId != null"> PROGRM_ID = #{progrmId, jdbcType=VARCHAR},</if>
			<if test="progrmNm != null"> PROGRM_NM = #{progrmNm, jdbcType=VARCHAR},</if>
			<if test="writtenReqYn != null"> WRITTEN_REQ_YN = #{writtenReqYn, jdbcType=VARCHAR},</if>
			<if test="writtenReqNo != null"> WRITTEN_REQ_NO = #{writtenReqNo, jdbcType=VARCHAR},</if>
			<if test="modrUid != null"> MODR_UID = #{modrUid, jdbcType=VARCHAR},</if>
			<if test="modDt != null"> 
				<if test="modDt == 'sysdate'"> MOD_DT = SYSDATE,</if>
				<if test="modDt == ''"> MOD_DT = NULL,</if>
				<if test="modDt != '' and modDt != 'sysdate'"> MOD_DT = TO_DATE(#{modDt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS'),</if>
			</if>
		</set>
		<where>
			<if test="reqNo != null and reqNo !=''"> AND REQ_NO = #{reqNo, jdbcType=VARCHAR}</if>
			<if test="compId != null and compId !=''"> AND COMP_ID = #{compId, jdbcType=VARCHAR}</if>
		</where>
	</update>

	<!-- 삭제 -->
	<delete id="deleteWhReqB" parameterType="WhReqBVo" >
		/* com.innobiz.orange.web.wh.dao.WhReqBDao.deleteWhReqB */
		DELETE FROM WH_REQ_B
		<where>
			<if test="reqNo != null"> AND REQ_NO = #{reqNo, jdbcType=VARCHAR}</if>
			<if test="compId != null and compId !=''"> AND COMP_ID = #{compId, jdbcType=VARCHAR}</if>
		</where>
	</delete>
	
	<!-- 현황 조회 -->
	<select id="selectDashBrd" resultMap="dashBrdMap" parameterType="WhReqBVo" >
		/* com.innobiz.orange.web.wh.dao.WhReqBDao.selectDashBrd */
		SELECT O.STAT_CD , COUNT(*) AS TOTAL_CNT
		FROM WH_REQ_B T <if test="withDtl"> INNER JOIN WH_REQ_ONGD_D O ON T.REQ_NO = O.REQ_NO </if>
		<include refid="selectWhReqBWhere"/>
		GROUP BY O.STAT_CD
	</select>
	
	<!-- 결과평가 조회 -->
	<select id="selectEvalList" resultMap="evalMap" parameterType="WhReqBVo" >
		/* com.innobiz.orange.web.wh.dao.WhReqBDao.selectEvalList */
		SELECT (SELECT RESC_VA FROM WH_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM WH_RES_EVAL_B WHERE EVAL_NO = E.EVAL_NO) AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR}, 'ko')) EVAL_NM,
				   COUNT(*) AS TOTAL_CNT
		FROM WH_REQ_B T <if test="withDtl"> INNER JOIN WH_REQ_ONGD_D O ON T.REQ_NO = O.REQ_NO </if>
									INNER JOIN WH_REQ_EVAL_D E ON T.REQ_NO = E.REQ_NO
		<include refid="selectWhReqBWhere"/>
		GROUP BY E.EVAL_NO
	</select>

</mapper>