<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- TABLE : CT_SCHDL_B[일정 기본] -->
<mapper namespace="com.innobiz.orange.web.ct.dao.CtSchdlBNewDao">

	<resultMap id="ctSchdlBMap" type="CtSchdlBVo">
		<id property="schdlId" column="SCHDL_ID" /><!-- 일정ID -->
		<result property="userUid" column="USER_UID" /><!-- 사용자UID -->
		<result property="compId" column="COMP_ID" /><!-- 회사ID -->
		<result property="deptId" column="DEPT_ID" /><!-- 부서ID -->
		<result property="grpId" column="GRP_ID" /><!-- 그룹ID -->
		<result property="schdlTypCd" column="SCHDL_TYP_CD" /><!-- 일정구분코드 -->
		<result property="schdlKndCd" column="SCHDL_KND_CD" /><!-- 일정종류코드 -->
		<result property="openGradCd" column="OPEN_GRAD_CD" /><!-- 공개등급코드 -->
		<result property="schdlStatCd" column="SCHDL_STAT_CD" /><!-- 일정상태코드 -->
		<result property="editorTypCd" column="EDITOR_TYP_CD" /><!-- 에디터구분코드 -->
		<result property="selfRegYn" column="SELF_REG_YN" /><!-- 본인입력여부 -->
		<result property="schdlStartDt" column="SCHDL_START_DT" /><!-- 일정시작일시 -->
		<result property="schdlEndDt" column="SCHDL_END_DT" /><!-- 일정종료일시 -->
		<result property="repetYn" column="REPET_YN" /><!-- 반복여부 -->
		<result property="holiYn" column="HOLI_YN" /><!-- 휴일여부 -->
		<result property="solaLunaYn" column="SOLA_LUNA_YN" /><!-- 양음력여부 -->
		<result property="subj" column="SUBJ" /><!-- 제목 -->
		<result property="locNm" column="LOC_NM" /><!-- 장소명 -->
		<result property="locLatdLotdVa" column="LOC_LATD_LOTD_VA" /><!-- 장소위도경도값 -->
		<result property="cont" column="CONT" /><!-- 내용 -->
		<result property="workPrioOrdr" column="WORK_PRIO_ORDR" /><!-- 할일우선순서 -->
		<result property="workCmltYmd" column="WORK_CMLT_YMD" /><!-- 할일완료년월일 -->
		<result property="attYn" column="ATT_YN" /><!-- 첨부여부 -->
		<result property="regrUid" column="REGR_UID" /><!-- 등록자UID -->
		<result property="regrNm" column="REGR_NM" /><!-- 등록자명 -->
		<result property="regDt" column="REG_DT" /><!-- 등록일시 -->
		<result property="modDt" column="MOD_DT" /><!-- 수정일시 -->
		<result property="modrUid" column="MODR_UID" /><!-- 수정자UID -->
		<result property="schdlFileId" column="SCHDL_FILE_ID" /><!-- 일정파일ID -->
		<result property="schdlPid" column="SCHDL_PID" /><!-- 일정 부모ID -->
		<result property="schdlYm" column="SCHDL_YM" /><!-- 해당 월별 년월 -->
		<result property="schdlPrevYm" column="SCHDL_PREVYM" /><!-- 이전 월별 년월 -->
		<result property="schdlNextYm" column="SCHDL_NEXTYM" /><!-- 이후 월별 년월 -->
		
		<result property="searchPromChk" column="SEARCH_PROM_CHK" /><!-- 검색약속체크 -->
		<result property="searchWorkChk" column="SEARCH_WORK_CHK" /><!-- 검색할일체크  -->
		<result property="searchEvntChk" column="SEARCH_EVNT_CHK" /><!-- 검색행사체크 -->
		<result property="searchAnnvChk" column="SEARCH_ANNV_CHK" /><!-- 검색기념일체크 -->
		<result property="searchPsnChk" column="SEARCH_PSN_CHK" /><!-- 검색개인체크 -->
		<result property="searchDeptChk" column="SEARCH_DEPT_CHK" /><!-- 검색부서체크 -->
		<result property="searchCompChk" column="SEARCH_COMP_CHK" /><!-- 검색회사체크 -->
		<result property="searchGrpChk" column="SEARCH_GRP_CHK" /><!-- 검색그룹체크 -->
		
		<result property="startHour" column="STARTHOUR" /><!-- 해당날짜의 시작시간 -->
		<result property="endHour" column="ENDHOUR" /><!-- 해당날짜의 종료 시간 -->
		
		<result property="repetStartDt" column="REPET_START_DT"/><!-- 반복시작일시 -->
		<result property="repetEndDt" column="REPET_END_DT"/><!-- 반복시작일시 -->
		
		<result property="schdlTypNm" column="SCHDL_TYP_NM"/><!-- 일정구분명 -->
		<result property="alldayYn" column="ALLDAY_YN"/><!-- 종일여부 -->
		<result property="grpNm" column="GRP_NM"/><!-- 그룹명 -->
		<result property="afterDay" column="AFTER_DAY"/><!-- 기간별 일수차 -->
		
		<result property="ctId" column="CT_ID" /><!--커뮤니티 ID-->
		<result property="ctFncId" column="CT_FNC_ID" /><!--커뮤니티 기능 ID-->
		<result property="ctFncLocStep" column="CT_FNC_LOC_STEP" /><!-- 커뮤니티 기능 위치 단계 -->
	  <result property="ctFncUid" column="CT_FNC_UID" /><!-- 커뮤니티 기능 UID -->
	  <result property="ctFncPid" column="CT_FNC_PID" /><!-- 커뮤니티 기능 부모ID -->
	  
	  <result property="ctNm" column="CT_NM" /><!--커뮤니티 명-->
		<result property="langTyp" column="LANG_TYP" /><!-- 사용자 언어 타입 코드 -->
		 <!-- 커뮤니티 자료검색  -->
	  <result property="fncNm" column="FNC_NM" /><!-- 기능명 -->
	  <result property="strtDt" column="START_DT" /><!--시작 일시-->
		<result property="endDt" column="END_DT" /><!--종료 일시-->
		<result property="ctFncUrl" column="CT_FNC_URL" /><!--커뮤니티 기능 URL -->
		<result property="relTblSubj" column="REL_TBL_SUBJ" /><!--관계테이블명 -->
		<result property="mastNm" column="MAST_NM" /><!-- 마스터명 -->
		<result property="mastUid" column="MAST_UID" /><!-- 마스터UID -->
		
	</resultMap>
	
	
	<!-- 조회조건 -->
	<sql id="selectSchdlBWhere">
		<where>
			<if test="schdlId != null and schdlId !=''"> AND T.SCHDL_ID = #{schdlId, jdbcType=VARCHAR}</if>
			<if test="ctId != null and ctId !=''"> AND T.CT_ID = #{ctId, jdbcType=VARCHAR}</if>
			<if test="ctFncId != null and ctFncId !=''"> AND T.CT_FNC_ID = #{ctFncId, jdbcType=VARCHAR}</if>
			<if test="ctFncLocStep != null and ctFncLocStep !=''"> AND T.CT_FNC_LOC_STEP = #{ctFncLocStep, jdbcType=VARCHAR}</if>
			<if test="ctFncUid != null and ctFncUid !=''"> AND T.CT_FNC_UID = #{ctFncUid, jdbcType=VARCHAR}</if>
			<if test="ctFncPid != null and ctFncPid !=''"> AND T.CT_FNC_PID = #{ctFncPid, jdbcType=VARCHAR}</if>
			<if test="schdlPid != null and schdlPid !=''"> AND T.SCHDL_PID = #{schdlPid, jdbcType=CHAR}</if>
			<if test="schWord != null and schWord !=''">AND T.SUBJ LIKE CONCAT('%', #{schWord, jdbcType=VARCHAR}, '%')
			</if>
			<if test="schdlStartDt != null and schdlStartDt != ''"><![CDATA[AND DATE_FORMAT(T.SCHDL_END_DT, '%Y-%m-%d') >= #{schdlStartDt, jdbcType=VARCHAR}]]></if>
			<if test="schdlEndDt != null and schdlEndDt != ''"><![CDATA[AND DATE_FORMAT(T.SCHDL_START_DT, '%Y-%m-%d') <= #{schdlEndDt, jdbcType=VARCHAR}]]></if>
			<if test="ctIdList != null">
       			AND CT_ID IN <foreach collection="ctIdList" item="item" index="index" separator="," open="(" close=")">#{item, jdbcType=VARCHAR}</foreach>				
			</if>
			<if test="schdlTypCd != null and schdlTypCd != ''">AND T.SCHDL_TYP_CD = #{schdlTypCd, jdbcType=VARCHAR}</if>
			<if test="compId != null and compId !=''"> AND T.COMP_ID = #{compId, jdbcType=VARCHAR}</if>
			<if test="repetYn != null and repetYn !=''"> AND T.REPET_YN = #{repetYn, jdbcType=VARCHAR}</if>
			<if test="whereSqllet != null and whereSqllet != ''"> ${whereSqllet}</if>	
		</where>
	</sql>
	
	<!-- 목록조회 -->
	<select id="selectCtSchdlToB" resultMap="ctSchdlBMap" parameterType="CtSchdlBVo" >
		/* com.innobiz.orange.web.ct.dao.CtSchdlBNewDao.selectCtSchdlToB */
		SELECT
		<trim prefix="" suffix="" suffixOverrides=",">
			  T.SCHDL_ID,
			T.USER_UID,
			T.COMP_ID,
			T.DEPT_ID,
			T.GRP_ID,
			T.SCHDL_TYP_CD,
			T.SCHDL_KND_CD,
			T.OPEN_GRAD_CD,
			T.SCHDL_STAT_CD,
			T.EDITOR_TYP_CD,
			T.SELF_REG_YN,
			T.SCHDL_START_DT,
			T.SCHDL_END_DT,
			T.REPET_YN,
			T.HOLI_YN,
			T.SOLA_LUNA_YN,
			T.SUBJ,
			T.LOC_NM,
			T.LOC_LATD_LOTD_VA,
			<if test="withLob">T.CONT,</if>
			T.WORK_PRIO_ORDR,
			T.WORK_CMLT_YMD,
			T.ATT_YN,
			T.REGR_UID,
			T.REGR_NM,
			T.REG_DT,
			T.MOD_DT,
			T.MODR_UID,
			T.SCHDL_FILE_ID,
			T.SCHDL_PID,
			T.ALLDAY_YN,
			T.CT_ID,
			T.CT_FNC_ID,
			T.CT_FNC_LOC_STEP,
			T.CT_FNC_UID,
			T.CT_FNC_PID,
			(SELECT REPET_START_DT FROM WC_REPET_SETUP_D WHERE SCHDL_ID = T.SCHDL_ID) REPET_START_DT,
			(SELECT REPET_END_DT FROM WC_REPET_SETUP_D WHERE SCHDL_ID = T.SCHDL_ID) REPET_END_DT,
			(SELECT RESC_VA FROM CT_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM CT_SCHDL_CAT_CLS_B WHERE CAT_ID = T.SCHDL_TYP_CD) AND LANG_TYP_CD = IFNULL(#{queryLang, jdbcType=VARCHAR},'ko') ) AS SCHDL_TYP_NM ,
			(SELECT GRP_NM FROM WC_SCHDL_GRP_B WSG_T WHERE T.GRP_ID = WSG_T.SCHDL_GRP_ID) AS GRP_NM,
			DATEDIFF(T.SCHDL_START_DT,T.SCHDL_END_DT) AS AFTER_DAY,
			(
				SELECT RESC_VA 
				FROM CT_RESC_B
				WHERE RESC_ID = (SELECT CT_SUBJ_RESC FROM CT_ESTB_B WHERE CT_ID = T.CT_ID)
				AND LANG_TYP_CD = #{langTyp, jdbcType=VARCHAR}
			) CT_NM,
			(
				SELECT RESC_VA FROM CT_RESC_B
				WHERE LANG_TYP_CD = #{langTyp, jdbcType=VARCHAR}
				AND RESC_ID = (SELECT CT_FNC_SUBJ_RESC_ID FROM CT_FNC_D WHERE CT_FNC_UID = T.CT_FNC_UID)
			) FNC_NM,
			(
				SELECT URL
				FROM CT_FNC_MNG_B
				WHERE T.CT_FNC_ID = CT_FNC_ID
			) CT_FNC_URL,
			(
				SELECT REL_TBL_SUBJ
				FROM CT_FNC_MNG_B
				WHERE T.CT_FNC_ID = CT_FNC_ID
			) REL_TBL_SUBJ,
			(
				SELECT RESC_VA
				FROM OR_RESC_B
				WHERE RESC_ID = (
					SELECT RESC_ID
					FROM OR_USER_B
					WHERE USER_UID = (
						SELECT MAST_UID
						FROM CT_ESTB_B
						WHERE T.CT_ID = CT_ID
					)
				)
				AND LANG_TYP_CD = #{queryLang, jdbcType=VARCHAR}
			) MAST_NM,
			(
				SELECT MAST_UID
				FROM CT_ESTB_B
				WHERE T.CT_ID = CT_ID
			) MAST_UID,
		</trim>
		FROM CT_SCHDL_B T
		<include refid="selectSchdlBWhere"/>
		<if test="orderBy != null">ORDER BY ${orderBy}</if>
		<if test="orderBy == null">ORDER BY T.SCHDL_ID</if>
		<if test="pageNo != null and pageRowCnt != null">
		LIMIT #{pageStrt, jdbcType=NUMERIC}, #{pageRowCnt, jdbcType=NUMERIC}
		</if>
	</select>
	
	<!-- 수정 -->
	<update id="updateSchdlB" parameterType="CtSchdlBVo" >
		/* com.innobiz.orange.web.ct.dao.CtSchdlBNewDao.updateSchdlB */
		UPDATE CT_SCHDL_B
		<set>
			<if test="schdlStartDt != null"> SCHDL_START_DT = STR_TO_DATE(#{schdlStartDt, jdbcType=VARCHAR}, '%Y-%m-%d %H:%i:%s'),</if>
			<if test="schdlEndDt != null"> SCHDL_END_DT = STR_TO_DATE(#{schdlEndDt, jdbcType=VARCHAR}, '%Y-%m-%d %H:%i:%s'),</if>
			<if test="schdlPid != null"> SCHDL_PID = #{schdlPid, jdbcType=VARCHAR},</if>
			<if test="repetYn != null"> REPET_YN = #{repetYn, jdbcType=VARCHAR},</if>
			<if test="alldayYn != null"> ALLDAY_YN = #{alldayYn, jdbcType=VARCHAR},</if>
		</set>
		WHERE SCHDL_ID = #{schdlId, jdbcType=VARCHAR}
		AND COMP_ID = #{compId, jdbcType=VARCHAR}
		AND CT_ID = #{ctId, jdbcType=VARCHAR}

	</update>

</mapper>