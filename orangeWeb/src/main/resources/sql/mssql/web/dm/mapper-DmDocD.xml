<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- TABLE : DM_DOC_D[문서상세] -->
<mapper namespace="com.innobiz.orange.web.dm.dao.DmDocDDao">

	<resultMap id="dmDocDMap" type="DmDocDVo">
		<id property="docGrpId" column="DOC_GRP_ID" /><!-- 문서그룹ID -->
		<result property="subYn" column="SUB_YN" /><!-- 하위여부 -->
		<result property="subDocGrpId" column="SUB_DOC_GRP_ID" /><!-- 하위문서그룹ID -->
		<result property="docPid" column="DOC_PID" /><!-- 부모PID -->
		<result property="sortOrdr" column="SORT_ORDR" /><!-- 정렬순서 -->
		<result property="sortDpth" column="SORT_DPTH" /><!-- 정렬단계 -->
		<result property="statCd" column="STAT_CD" /><!-- 상태코드 -->
		<result property="fldId" column="FLD_ID" /><!-- 폴더ID -->
		<result property="fldNm" column="FLD_NM" /><!-- 폴더명 -->
		<result property="docNo" column="DOC_NO" /><!-- 문서번호 -->
		<result property="ownrUid" column="OWNR_UID" /><!-- 소유자ID -->
		<result property="ownrNm" column="OWNR_NM" /><!-- 소유자명 -->
		<result property="docKeepPrdCd" column="DOC_KEEP_PRD_CD" /><!-- 문서보존기간코드 -->
		<result property="docKeepPrdNm" column="DOC_KEEP_PRD_NM" /><!-- 문서보존기간명 -->
		<result property="seculCd" column="SECUL_CD" /><!-- 보안등급코드 -->
		<result property="seculNm" column="SECUL_NM" /><!-- 보안등급명 -->
		<result property="cmplDt" column="CMPL_DT" /><!-- 완료일시 -->
		<result property="readCnt" column="READ_CNT" /><!-- 조회수 -->
		<result property="keepPrdDt" column="KEEP_PRD_DT" /><!-- 분류체계ID -->
		<result property="keepDdlnDt" column="KEEP_DDLN_DT" /><!-- 보존기한 -->
		<result property="refTyp" column="REF_TYP" /><!-- 참조구분 -->
		<result property="refId" column="REF_ID" /><!-- 참조ID -->
		<result property="refUrl" column="REF_URL" /><!-- 참조URL -->
		<result property="orgnYn" column="ORGN_YN" /><!-- 원본여부 -->
	</resultMap>

	<!-- 조회조건 -->
	<sql id="selectDmDocDWhere">
		<where>
			<if test="docGrpId != null and docGrpId !=''"> AND T.DOC_GRP_ID = #{docGrpId, jdbcType=VARCHAR}</if>
			<if test="subYn != null and subYn !=''"> AND T.SUB_YN = #{subYn, jdbcType=VARCHAR}</if>
			<if test="fldId != null and fldId !=''"> AND T.FLD_ID = #{fldId, jdbcType=VARCHAR}</if>
			<if test="subDocGrpId != null and subDocGrpId !=''"> AND T.SUB_DOC_GRP_ID = #{subDocGrpId, jdbcType=VARCHAR}</if>
			<if test="docPid != null">
				<if test='"".equals(docPid)'> AND T.DOC_PID IS NULL</if> 
				<if test='!"".equals(docPid)'> AND T.DOC_PID = #{docPid, jdbcType=VARCHAR}</if> 
			</if>
			<if test="sortOrdr != null"> T.SORT_ORDR = #{sortOrdr, jdbcType=VARCHAR},</if>
			<if test="sortDpth != null and sortDpth !=''"> AND T.SORT_DPTH = #{sortDpth, jdbcType=VARCHAR}</if>
			<if test="statCd != null and statCd !=''"> AND T.STAT_CD = #{statCd, jdbcType=VARCHAR}</if>
			<if test="ownrUid != null and ownrUid !=''"> AND T.OWNR_UID = #{ownrUid, jdbcType=VARCHAR}</if>
			<if test="docKeepPrdCd != null and docKeepPrdCd !=''"> AND T.DOC_KEEP_PRD_CD = #{docKeepPrdCd, jdbcType=VARCHAR}</if>
			<if test="seculCd != null and seculCd !=''"> AND T.SECUL_CD = #{seculCd, jdbcType=VARCHAR}</if>
			<if test="keepPrdDt != null and keepPrdDt !=''"> AND CONVERT(CHAR(10), T.KEEP_PRD_DT, 120) = #{keepPrdDt, jdbcType=VARCHAR}</if>
			<if test="'cmplDt'.equals(durCat) and durStrtDt != null and durStrtDt != ''"><![CDATA[AND CONVERT(CHAR(10), T.CMPL_DT, 23) >= #{durStrtDt, jdbcType=VARCHAR}]]></if>
			<if test="'cmplDt'.equals(durCat) and durEndDt != null and durEndDt != ''"><![CDATA[AND CONVERT(CHAR(10), T.CMPL_DT, 23) <= #{durEndDt, jdbcType=VARCHAR}]]></if>
			<if test="refTyp != null and refTyp !=''"> AND T.REF_TYP = #{refTyp, jdbcType=VARCHAR}</if>
			<if test="refId != null and refId !=''"> AND T.REF_ID = #{refId, jdbcType=VARCHAR}</if>
			<if test="whereSqllet != null and whereSqllet != ''"> ${whereSqllet}</if>
		</where>
	</sql>
	
	<!-- 목록조회 -->
	<select id="selectDmDocD" resultMap="dmDocDMap" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.dm.dao.DmDocDDao.selectDmDocD */
		<if test="pageNo != null and pageRowCnt != null">
		SELECT * FROM (
		</if>
		SELECT
		<trim prefix="" suffix="" suffixOverrides=",">
			<if test="pageNo != null and pageRowCnt != null">
			TOP (#{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}) ROW_NUMBER() OVER (ORDER BY <if test="orderBy != null">${orderBy}</if><if test="orderBy == null">N.KEEP_PRD_DT DESC</if>) AS RNUM, N.* FROM (SELECT
			</if>
			T.DOC_GRP_ID,
			T.SUB_YN,
			T.SUB_DOC_GRP_ID,
			T.DOC_PID,
			T.SORT_ORDR,
			T.SORT_DPTH,
			T.STAT_CD,
			T.FLD_ID,
			T.DOC_NO,
			T.KEEP_PRD_DT,
			T.OWNR_UID,
			(SELECT RESC_VA FROM OR_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM OR_USER_B WHERE USER_UID = T.OWNR_UID) AND LANG_TYP_CD = ISNULL(#{queryLang, jdbcType=VARCHAR},'ko')) OWNR_NM,
			T.DOC_KEEP_PRD_CD,
			(SELECT RESC_VA FROM PT_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM PT_CD_B WHERE CLS_CD = 'DOC_KEEP_PRD_CD' AND CD = T.DOC_KEEP_PRD_CD) AND LANG_TYP_CD = ISNULL(#{queryLang, jdbcType=VARCHAR},'ko')) DOC_KEEP_PRD_NM,
			T.SECUL_CD,
			(SELECT RESC_VA FROM PT_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM PT_CD_B WHERE CLS_CD = 'SECUL_CD' AND CD = T.SECUL_CD) AND LANG_TYP_CD = ISNULL(#{queryLang, jdbcType=VARCHAR},'ko')) SECUL_NM,
			T.CMPL_DT,
			T.READ_CNT,
			T.REF_TYP,
			T.REF_ID,
			T.REF_URL,
			T.ORGN_YN,
		</trim>
		FROM DM_${tableName}_DOC_D T
		<include refid="selectDmDocDWhere"/>
		<if test="pageNo == null or pageRowCnt == null">
			<if test="orderBy != null">ORDER BY ${orderBy}</if>
			<if test="orderBy == null">ORDER BY T.KEEP_PRD_DT</if>
		</if>
		<if test="pageNo != null and pageRowCnt != null">
		<![CDATA[) N ) M WHERE RNUM > (#{pageNo, jdbcType=NUMERIC} - 1) * #{pageRowCnt, jdbcType=NUMERIC} AND RNUM <= #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}]]>
		</if>
	</select>
	
	<!-- 목록조회 건수-->
	<select id="countDmDocD" resultType="Integer" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.dm.dao.DmDocDDao.countDmDocD */
		SELECT COUNT(*) CNT
		FROM DM_${tableName}_DOC_D T
		<include refid="selectDmDocDWhere"/>
	</select>
	
	<!-- 등록 저장 -->
	<insert id="insertDmDocD" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.dm.dao.DmDocDDao.insertDmDocD */
		INSERT INTO DM_${tableName}_DOC_D
		<trim prefix="(" suffix=")" suffixOverrides=",">
			DOC_GRP_ID,
			SUB_YN,
			SUB_DOC_GRP_ID,
			DOC_PID,
			SORT_ORDR,
			SORT_DPTH,
			STAT_CD,
			FLD_ID,
			DOC_NO,
			KEEP_PRD_DT,
			OWNR_UID,
			DOC_KEEP_PRD_CD,
			SECUL_CD,
			CMPL_DT,
			READ_CNT,
			REF_TYP,
			REF_ID,
			REF_URL,
			ORGN_YN,
		</trim>
		<trim prefix="VALUES (" suffix=")" suffixOverrides="," >
			#{docGrpId, jdbcType=VARCHAR},
			#{subYn, jdbcType=VARCHAR},
			#{subDocGrpId, jdbcType=VARCHAR},
			#{docPid, jdbcType=VARCHAR},
			#{sortOrdr, jdbcType=INTEGER},
			#{sortDpth, jdbcType=INTEGER},
			#{statCd, jdbcType=VARCHAR},
			#{fldId, jdbcType=VARCHAR},
			#{docNo, jdbcType=VARCHAR},
			<if test="keepPrdDt == null or keepPrdDt == ''">NULL,</if><if test="keepPrdDt != null and keepPrdDt != ''">CONVERT(DATETIME, #{keepPrdDt, jdbcType=VARCHAR}, 120),</if>
			#{ownrUid, jdbcType=VARCHAR},
			#{docKeepPrdCd, jdbcType=VARCHAR},
			#{seculCd, jdbcType=VARCHAR},
			<if test="cmplDt == 'sysdate'">GETDATE(),</if><if test="cmplDt == null or cmplDt == ''">NULL,</if><if test="cmplDt != null and cmplDt != '' and cmplDt != 'sysdate'">CONVERT(DATETIME, #{cmplDt, jdbcType=VARCHAR}, 120),</if>
			0,
			#{refTyp, jdbcType=VARCHAR},
			#{refId, jdbcType=VARCHAR},
			#{refUrl, jdbcType=VARCHAR},
			#{orgnYn, jdbcType=VARCHAR},
		</trim>
	</insert>
	
	<update id="updateDmDocD" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.pt.dao.DmDocDDao.updateDmDocD */
		UPDATE DM_${tableName}_DOC_D
		<set>
			<if test="subYn != null"> SUB_YN = #{subYn, jdbcType=VARCHAR},</if>
			<if test="subDocGrpId != null"> SUB_DOC_GRP_ID = #{subDocGrpId, jdbcType=VARCHAR},</if>
			<if test="docPid != null">
				<if test='"".equals(docPid)'> DOC_PID = NULL,</if> 
				<if test='!"".equals(docPid)'> DOC_PID = #{docPid, jdbcType=VARCHAR},</if> 
			</if>
			<!-- <if test="docGrpId != null"> DOC_GRP_ID = #{docGrpId, jdbcType=VARCHAR},</if> -->
			<if test="sortOrdr != null"> SORT_ORDR = #{sortOrdr, jdbcType=VARCHAR},</if>
			<if test="sortDpth != null"> SORT_DPTH = #{sortDpth, jdbcType=VARCHAR},</if>
			<if test="keepPrdDt != null">
				<if test='"".equals(keepPrdDt)'> KEEP_PRD_DT = NULL,</if>
				<if test='!"".equals(keepPrdDt)'> KEEP_PRD_DT = CONVERT(DATETIME, #{keepPrdDt, jdbcType=VARCHAR}, 120),</if>
			</if>
			<if test="statCd != null"> STAT_CD = #{statCd, jdbcType=VARCHAR},</if>
			<if test="docNo != null"> DOC_NO = #{docNo, jdbcType=VARCHAR},</if>
			<if test="ownrUid != null"> OWNR_UID = #{ownrUid, jdbcType=VARCHAR},</if>
			<if test="docKeepPrdCd != null"> DOC_KEEP_PRD_CD = #{docKeepPrdCd, jdbcType=VARCHAR},</if>
			<if test="seculCd != null"> SECUL_CD = #{seculCd, jdbcType=VARCHAR},</if>
			<if test="refTyp != null"> REF_TYP = #{refTyp, jdbcType=VARCHAR},</if>
			<if test="refId != null"> REF_ID = #{refId, jdbcType=VARCHAR},</if>
			<if test="refUrl != null"> REF_URL = #{refUrl, jdbcType=VARCHAR},</if>
			<if test="orgnYn != null"> ORGN_YN = #{orgnYn, jdbcType=VARCHAR},</if>
			<if test="cmplDt != null"> 
				<if test="cmplDt == 'sysdate'"> CMPL_DT = GETDATE(),</if>
				<if test="cmplDt == ''"> CMPL_DT = NULL,</if>
				<if test="cmplDt != '' and cmplDt != 'sysdate'"> CMPL_DT = CONVERT(DATETIME, #{cmplDt, jdbcType=VARCHAR}, 120),</if>
			</if>
			<if test="readCnt != null"> READ_CNT = #{readCnt, jdbcType=VARCHAR},</if>
			<if test="fldId != null"> FLD_ID = #{fldId, jdbcType=VARCHAR},</if>
		</set>
		WHERE DOC_GRP_ID = #{docGrpId, jdbcType=VARCHAR}
		<!-- <where>
			<if test="docGrpId != null and docGrpId !=''"> AND DOC_GRP_ID = #{docGrpId, jdbcType=VARCHAR}</if>
		</where> -->
	</update>
	
	<!-- 조회수 증가 -->
	<update id="updateReadCnt" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.dm.dao.DmDocDDao.updateReadCnt */
		UPDATE DM_${tableName}_DOC_D
		<set>
			READ_CNT = READ_CNT + 1,
		</set>
		WHERE DOC_GRP_ID = #{docGrpId, jdbcType=VARCHAR}
	</update>
	
	<!-- 조회수 초기화 -->
	<update id="updateReadCntInit" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.dm.dao.DmDocDDao.updateReadCntInit */
		UPDATE DM_${tableName}_DOC_D
		<set>
			<if test="readCnt == 0"> READ_CNT = #{readCnt, jdbcType=VARCHAR},</if>
			<if test="readCnt != 0"> READ_CNT = READ_CNT - #{readCnt, jdbcType=INTEGER},</if>
		</set>
		WHERE DOC_GRP_ID = #{docGrpId, jdbcType=VARCHAR}
	</update>
	
	<!-- 삭제 -->
	<delete id="deleteDmDocD" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.dm.dao.DmDocDDao.deleteDmDocD */
		DELETE FROM DM_${tableName}_DOC_D
		WHERE DOC_GRP_ID = #{docGrpId, jdbcType=VARCHAR}
		<!-- <where>
			<if test="docGrpId != null and docGrpId !=''"> AND DOC_GRP_ID = #{docGrpId, jdbcType=VARCHAR}</if>
		</where> -->
	</delete>
	
	<!-- 문서그룹의 최대 정렬순서 -->
	<select id="selectMaxSortOrdr" resultType="int" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.dm.dao.DmDocDDao.selectMaxSortOrdr */
		SELECT MAX(SORT_ORDR) SORT_ORDR
		FROM DM_${tableName}_DOC_D T
		<where>
			AND T.SUB_DOC_GRP_ID = #{subDocGrpId, jdbcType=INTEGER}
		</where>
	</select>
	
	<!-- 하위문서의 정렬순서 -->
	<select id="selectMinSortOrdr" resultType="int" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.dm.dao.DmDocDDao.selectMinSortOrdr */
		SELECT MIN(SORT_ORDR) SORT_ORDR
		FROM DM_${tableName}_DOC_D T
		<where>
			<!-- AND T.SUB_YN = #{subYn, jdbcType=VARCHAR} -->
			<![CDATA[
			AND T.SUB_DOC_GRP_ID = #{subDocGrpId, jdbcType=INTEGER}
			AND T.SORT_ORDR > #{sortOrdr, jdbcType=INTEGER}
			AND T.SORT_DPTH <= #{sortDpth, jdbcType=INTEGER}
			]]>
		</where>
	</select>
	
	<!-- 기존문서의 정렬순서를 삽입된 문서들의 다음으로 일괄 변경 -->
	<update id="updateMaxSortOrdr" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.dm.dao.DmDocLDao.updateMaxSortOrdr */
		UPDATE DM_${tableName}_DOC_D
		<set>
			SORT_ORDR = SORT_ORDR+#{maxSortOrdr, jdbcType=INTEGER}
		</set>
		<where>
			AND FLD_ID = #{fldId, jdbcType=VARCHAR}
			AND SUB_DOC_GRP_ID = #{subDocGrpId, jdbcType=VARCHAR}
			<![CDATA[AND SORT_ORDR >= #{sortOrdr, jdbcType=INTEGER}]]>
		</where>
	</update>
	
	<!-- 기존문서의 정렬순서를 제거된 문서만큼 일괄 변경 - 문서이동시에만 적용 -->
	<update id="updateMinSortOrdr" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.dm.dao.DmDocLDao.updateMinSortOrdr */
		UPDATE DM_${tableName}_DOC_D
		<set>
			SORT_ORDR = SORT_ORDR-1
		</set>
		<where>
			AND FLD_ID = #{fldId, jdbcType=VARCHAR}
			AND SUB_DOC_GRP_ID = #{subDocGrpId, jdbcType=VARCHAR}
			<![CDATA[AND SORT_ORDR >= #{sortOrdr, jdbcType=INTEGER}]]>
		</where>
	</update>
	
	<!-- 이관대기 문서로 일괄 상태 변경 -->
	<update id="updateSelectDmDocD" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.dm.dao.DmDocDDao.updateSelectDmDocD */
		UPDATE T SET STAT_CD = 'M'
		FROM DM_${tableName}_DOC_D T INNER JOIN (
			SELECT DOC_GRP_ID FROM DM_${tableName}_DOC_L
			<where>
			<if test="'regDt'.equals(durCat) and durStrtDt != null and durStrtDt != ''"><![CDATA[AND CONVERT(CHAR(10), REG_DT, 23) >= #{durStrtDt, jdbcType=VARCHAR}]]></if>
			<if test="'regDt'.equals(durCat) and durEndDt != null and durEndDt != ''"><![CDATA[AND CONVERT(CHAR(10), REG_DT, 23) <= #{durEndDt, jdbcType=VARCHAR}]]></if>
			</where>			 
			GROUP BY DOC_GRP_ID
			) L ON T.DOC_GRP_ID = L.DOC_GRP_ID
		WHERE T.STAT_CD = #{statCd, jdbcType=VARCHAR}
	</update>
	
	<!-- 이관대기 문서를 원래 상태로 변경  -->
	<update id="updateTranDmDocD" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.dm.dao.DmDocDDao.updateTranDmDocD */
		UPDATE T SET STAT_CD = 'C'
		FROM DM_${tableName}_DOC_D T INNER JOIN DM_DOC_TRAN_L L ON T.DOC_GRP_ID = L.DOC_GRP_ID AND L.TRAN_ID = #{tranId, jdbcType=VARCHAR} 
		WHERE T.STAT_CD = 'M'
	</update>
	
	<!-- 이관대상 목록조회 건수-->
	<select id="countSelectDmDocD" resultType="Integer" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.dm.dao.DmDocDDao.countSelectDmDocD */
		SELECT COUNT(T.DOC_GRP_ID) CNT
		FROM DM_${tableName}_DOC_D T INNER JOIN (
			SELECT DOC_GRP_ID FROM DM_${tableName}_DOC_L
			<where>
			<if test="'regDt'.equals(durCat) and durStrtDt != null and durStrtDt != ''"><![CDATA[AND CONVERT(CHAR(10), REG_DT, 23) >= #{durStrtDt, jdbcType=VARCHAR}]]></if>
			<if test="'regDt'.equals(durCat) and durEndDt != null and durEndDt != ''"><![CDATA[AND CONVERT(CHAR(10), REG_DT, 23) <= #{durEndDt, jdbcType=VARCHAR}]]></if>
			</where>			 
			GROUP BY DOC_GRP_ID
			) L ON T.DOC_GRP_ID = L.DOC_GRP_ID
		WHERE T.STAT_CD = #{statCd, jdbcType=VARCHAR}
	</select>
	
	<!-- 인계대기 문서를 원래 상태로 변경  -->
	<update id="updateTakovrDmDocD" parameterType="DmDocDVo" >
		/* com.innobiz.orange.web.dm.dao.DmDocDDao.updateTakovrDmDocD */
		UPDATE T SET STAT_CD = 'C'
		FROM DM_${tableName}_DOC_D T 
		WHERE T.STAT_CD = #{statCd, jdbcType=VARCHAR}
	</update>
	
</mapper>