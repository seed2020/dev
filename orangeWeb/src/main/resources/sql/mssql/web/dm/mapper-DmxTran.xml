<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- TABLE : DM_TRAN_TGT_T[이관대상임시] -->
<mapper namespace="com.innobiz.orange.web.dm.dao.DmxTranDao">
		
	<!-- 이관 대상 건수 조회-->
	<select id="selectDmxTranCnt" resultType="Integer" parameterType="DmxTranVo" >
		/* com.innobiz.orange.web.dm.dao.DmxTranDao.selectDmxTranCnt */
		SELECT COUNT(T.DOC_GRP_ID) CNT
		FROM DM_${srcTbl}_DOC_D T INNER JOIN (
			SELECT DOC_GRP_ID FROM DM_${srcTbl}_DOC_L
			<where>
			<if test="'regDt'.equals(durCat) and durStrtDt != null and durStrtDt != ''"><![CDATA[AND REG_DT >= CONVERT(DATETIME, #{durStrtDt, jdbcType=VARCHAR}, 120)]]></if>
			<if test="'regDt'.equals(durCat) and durEndDt != null and durEndDt != ''"><![CDATA[AND REG_DT <= CONVERT(DATETIME, #{durEndDt, jdbcType=VARCHAR}, 120)]]></if>
			</where>
			GROUP BY DOC_GRP_ID
			) L ON T.DOC_GRP_ID = L.DOC_GRP_ID
		<where>
		<if test="whereSqllet != null and whereSqllet != ''"> ${whereSqllet}</if>
		</where>
	</select>
	
	<!-- 2. 이관 대상 추출 -->
	<insert id="extractTransferingData" parameterType="DmxTranVo">
		/* com.innobiz.orange.web.dm.dao.DmxTranDao.extractTransferingData */
		INSERT INTO DM_TRAN_TGT_T (TRAN_ID, TRAN_SEQ, DOC_GRP_ID)
		SELECT #{tranId, jdbcType=VARCHAR} TRAN_ID, ${rnumSql} RNUM, T.DOC_GRP_ID
		FROM DM_${srcTbl}_DOC_D T INNER JOIN (
			SELECT DOC_GRP_ID FROM DM_${srcTbl}_DOC_L
			<where>
			<if test="'regDt'.equals(durCat) and durStrtDt != null and durStrtDt != ''"><![CDATA[AND REG_DT >= CONVERT(DATETIME, #{durStrtDt, jdbcType=VARCHAR}, 120)]]></if>
			<if test="'regDt'.equals(durCat) and durEndDt != null and durEndDt != ''"><![CDATA[AND REG_DT <= CONVERT(DATETIME, #{durEndDt, jdbcType=VARCHAR}, 120)]]></if>
			</where>			 
			GROUP BY DOC_GRP_ID
			) L ON T.DOC_GRP_ID = L.DOC_GRP_ID
		<where>
		<if test="whereSqllet != null and whereSqllet != ''"> ${whereSqllet}</if>
		</where>
		ORDER BY T.DOC_GRP_ID
	</insert>
	
	<!-- 3. 공통데이터 복사 - 각 테이블에서 실행 -->
	
	<!-- 4-1. 데이터 이관 - 문서그룹ID 기준-->
	<insert id="copyTransferingData" parameterType="DmxTranVo">
		/* com.innobiz.orange.web.dm.dao.DmxTranDao.copyTransferingData */<![CDATA[
		INSERT INTO ${tgtTbl}
		SELECT * 
		FROM ${srcTbl}
		WHERE ${keyCol} IN (
			SELECT DOC_GRP_ID
			FROM DM_TRAN_TGT_T
			WHERE TRAN_ID = #{tranId, jdbcType=VARCHAR}
				AND TRAN_SEQ > #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}
				AND TRAN_SEQ <= (#{pageNo, jdbcType=NUMERIC} + 1) * #{pageRowCnt, jdbcType=NUMERIC}
		)
		ORDER BY ${orderBy}]]>
	</insert>
	
	<!-- 4-2. 데이터 이관 - 문서ID 기준-->
	<insert id="copyTransferingDocData" parameterType="DmxTranVo">
		/* com.innobiz.orange.web.dm.dao.DmxTranDao.copyTransferingDocData */<![CDATA[
		INSERT INTO ${tgtTbl}
		SELECT * 
		FROM ${srcTbl}
		WHERE ${keyCol} IN (
			SELECT ${subKeyCol}
			FROM ${subTbl}
			WHERE DOC_GRP_ID IN(
				SELECT DOC_GRP_ID
				FROM DM_TRAN_TGT_T
				WHERE TRAN_ID = #{tranId, jdbcType=VARCHAR}
					AND TRAN_SEQ > #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}
					AND TRAN_SEQ <= (#{pageNo, jdbcType=NUMERIC} + 1) * #{pageRowCnt, jdbcType=NUMERIC}
			)
		)
		ORDER BY ${orderBy}]]>
	</insert>
	
	<!-- 5. 이관 문서 저장소 변경 : 삭제 -->
	<delete id="deleteStorageOfData" parameterType="DmxTranVo">
		/* com.innobiz.orange.web.dm.dao.DmxTranDao.deleteStorageOfData */<![CDATA[
		DELETE FROM DM_STOR_DOC_R WHERE DOC_GRP_ID IN (
			SELECT DOC_GRP_ID
			FROM DM_TRAN_TGT_T
			WHERE TRAN_ID = #{tranId, jdbcType=VARCHAR}				
				AND TRAN_SEQ > #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}
				AND TRAN_SEQ <= (#{pageNo, jdbcType=NUMERIC} + 1) * #{pageRowCnt, jdbcType=NUMERIC}
		)]]>
	</delete>
	<!-- 6. 이관 문서 저장소 변경 : 입력 -->
	<insert id="insertStorageOfData" parameterType="DmxTranVo">
		/* com.innobiz.orange.web.dm.dao.DmxTranDao.insertStorageOfData */<![CDATA[
		INSERT INTO DM_STOR_DOC_R (DOC_GRP_ID, STOR_ID)
		SELECT DOC_GRP_ID, #{storId, jdbcType=VARCHAR} STOR_ID
		FROM DM_TRAN_TGT_T
		WHERE TRAN_ID = #{tranId, jdbcType=VARCHAR}
			AND TRAN_SEQ > #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}
			AND TRAN_SEQ <= (#{pageNo, jdbcType=NUMERIC} + 1) * #{pageRowCnt, jdbcType=NUMERIC}]]>
	</insert>
	
	<!-- 7-1. 이관된 데이터 삭제 - 문서그룹ID 기준-->
	<insert id="deleteTransferedData" parameterType="DmxTranVo">
		/* com.innobiz.orange.web.dm.dao.DmxTranDao.deleteTransferedData */<![CDATA[
		DELETE FROM ${srcTbl}
		WHERE ${keyCol} IN (
			SELECT DOC_GRP_ID
			FROM DM_TRAN_TGT_T
			WHERE TRAN_ID = #{tranId, jdbcType=VARCHAR}
				AND TRAN_SEQ > #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}
				AND TRAN_SEQ <= (#{pageNo, jdbcType=NUMERIC} + 1) * #{pageRowCnt, jdbcType=NUMERIC}
		)]]>
	</insert>
	
	<!-- 7-2. 이관된 데이터 삭제 - 문서ID 기준-->
	<insert id="deleteTransferedDocData" parameterType="DmxTranVo">
		/* com.innobiz.orange.web.dm.dao.DmxTranDao.deleteTransferedDocData */<![CDATA[
		DELETE FROM ${srcTbl}
		WHERE ${keyCol} IN (
			SELECT ${subKeyCol}
			FROM ${subTbl}
			WHERE DOC_GRP_ID IN(
				SELECT DOC_GRP_ID
				FROM DM_TRAN_TGT_T
				WHERE TRAN_ID = #{tranId, jdbcType=VARCHAR}
					AND TRAN_SEQ > #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}
					AND TRAN_SEQ <= (#{pageNo, jdbcType=NUMERIC} + 1) * #{pageRowCnt, jdbcType=NUMERIC}
			)
		)]]>
	</insert>
	 
	<!-- 8. 데이터 조각 모음 / MSSQL -->
	<update id="processDefragmentationForMSSQL" parameterType="DmxTranVo">
		/* com.innobiz.orange.web.dm.dao.DmxTranDao.processDefragmentationForMSSQL */
		ALTER INDEX ALL ON ${srcTbl} REBUILD WITH (PAD_INDEX = ON, FILLFACTOR = 90)
	</update>
	
	<!-- 8. 데이터 조각 모음 / ORACLE -->
	<update id="processDefragmentationForORACLE" parameterType="DmxTranVo">
		/* com.innobiz.orange.web.dm.dao.DmxTranDao.processDefragmentationForORACLE */<if
	test="sqlSeq == 1">
		ALTER TABLE ${srcTbl} NOLOGGING</if><if
	test="sqlSeq == 2">
		ALTER INDEX ${idxNm} NOLOGGING</if><if
	test="sqlSeq == 3">
		ALTER TABLE ${srcTbl} ENABLE ROW MOVEMENT</if><if
	test="sqlSeq == 4">
		ALTER TABLE ${srcTbl} SHRINK SPACE CASCADE</if><if
	test="sqlSeq == 5">
		ALTER TABLE ${srcTbl} DISABLE ROW MOVEMENT</if><if
	test="sqlSeq == 6">
		ALTER INDEX ${idxNm} LOGGING</if><if
	test="sqlSeq == 7">
		ALTER TABLE ${srcTbl} LOGGING</if>
	</update>
	
	<!-- 테이블의 인덱스 조회 -->
	<select id="queryIndexForORACLE" parameterType="DmxTranVo" resultType="String">
		/* com.innobiz.orange.web.dm.dao.DmxTranDao.queryIndexForORACLE */
		SELECT INDEX_NAME FROM USER_INDEXES WHERE TABLE_NAME = #{srcTbl, jdbcType=VARCHAR}
	</select>
	
	<select id="queryMaxTranProcSeq" parameterType="DmxTranVo" resultType="Integer">
		/* com.innobiz.orange.web.dm.dao.DmxTranDao.queryMaxTranProcSeq */
		SELECT MAX(SEQ) SEQ FROM DM_TRAN_PROC_L WHERE TRAN_ID = #{tranId, jdbcType=VARCHAR}
	</select>

</mapper>