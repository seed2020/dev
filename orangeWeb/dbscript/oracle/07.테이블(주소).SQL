/****** Object:  Table [dbo].[EM_ADR_BLD_INFO_B_ALL]    Script Date: 2015/08/24 11:48 - 주소전체 : 가공을 위한 전체 데이터 ******/
--DROP TABLE EM_ADR_BLD_INFO_B_ALL CASCADE CONSTRAINT PURGE;
-- AL32UTF8 ==> date length 변경
CREATE TABLE EM_ADR_BLD_INFO_B_ALL(
LOW_TOWN_CD VARCHAR2(10) NOT NULL,
SIDO VARCHAR2(80) NOT NULL,
GUGUN VARCHAR2(80),
DONG VARCHAR2(80) NULL,
RI VARCHAR2(80),
MT_YN VARCHAR2(5),
MAIN_LOT_NO NUMBER,
SUB_LOT_NO NUMBER,
ROAD_NM_CD VARCHAR2(25),
ROAD_NM VARCHAR2(120),
BASEMENT_YN VARCHAR2(5),
MAIN_BLD_NO NUMBER,
SUB_BLD_NO NUMBER,
BLD_NM VARCHAR2(80),
BLD_DETL_NM VARCHAR2(200),
BLD_MNG_NO VARCHAR2(25) NOT NULL,
DONG_SEQ VARCHAR2(10) NOT NULL,
GOV_TOWN_CD VARCHAR2(15),
GOV_TOWN_NM VARCHAR2(40),
ZIP_NO VARCHAR2(10),
ZIP_SEQ VARCHAR2(3),
BULK_DELIVERY_NM VARCHAR2(80),
MOVE_REASON_CD VARCHAR2(5),
NOTICE_YMD VARCHAR2(25),
BEFORE_ROAD_ADR VARCHAR2(25),
CITY_PUBLIC_BLD_NM VARCHAR2(300),
APT_HOURSE_YN VARCHAR2(5),
DFT_ZONE_NO VARCHAR2(5),
DETL_ADR_YN CHAR(5),
NOTE1 VARCHAR2(30),
NOTE2 VARCHAR2(30)
)
TABLESPACE TS_GW_ZP
STORAGE (INITIAL 1000M NEXT 50M MAXEXTENTS UNLIMITED)
LOGGING
NOPARALLEL;

--UTF-8
/** CREATE TABLE EM_ADR_BLD_INFO_B_ALL(
LOW_TOWN_CD VARCHAR2(10) NOT NULL,
SIDO VARCHAR2(40) NOT NULL,
GUGUN VARCHAR2(40),
DONG VARCHAR2(40) NOT NULL,
RI VARCHAR2(40),
MT_YN CHAR(1),
MAIN_LOT_NO NUMBER,
SUB_LOT_NO NUMBER,
ROAD_NM_CD VARCHAR2(12),
ROAD_NM VARCHAR2(80),
BASEMENT_YN CHAR(1),
MAIN_BLD_NO NUMBER,
SUB_BLD_NO NUMBER,
BLD_NM VARCHAR2(40),
BLD_DETL_NM VARCHAR2(100),
BLD_MNG_NO VARCHAR2(25) NOT NULL,
DONG_SEQ VARCHAR2(2) NOT NULL,
GOV_TOWN_CD VARCHAR2(10),
GOV_TOWN_NM VARCHAR2(20),
ZIP_NO VARCHAR2(10),
ZIP_SEQ VARCHAR2(3),
BULK_DELIVERY_NM VARCHAR2(40),
MOVE_REASON_CD VARCHAR2(2),
NOTICE_YMD VARCHAR2(8),
BEFORE_ROAD_ADR VARCHAR2(25),
CITY_PUBLIC_BLD_NM VARCHAR2(200),
APT_HOURSE_YN CHAR(1),
DFT_ZONE_NO VARCHAR2(5),
DETL_ADR_YN CHAR(1),
NOTE1 VARCHAR2(15),
NOTE2 VARCHAR2(15),
CONSTRAINT PK_PT_ADR_BLD_INFO_B_ALL PRIMARY KEY
(
BLD_MNG_NO
))
TABLESPACE TS_GW_ZP
STORAGE (INITIAL 1000M NEXT 50M MAXEXTENTS UNLIMITED)
LOGGING
NOPARALLEL;
*/

-- 임시테이블에 중복제거 주소데이터 저장
--DROP TABLE EM_ADR_BLD_INFO_B_GROUP
CREATE TABLE EM_ADR_BLD_INFO_B_GROUP AS 
SELECT * FROM  EM_ADR_BLD_INFO_B_ALL 
WHERE BLD_MNG_NO IN(
	SELECT MIN(BLD_MNG_NO) BLD_MNG_NO
	FROM EM_ADR_BLD_INFO_B_ALL
	GROUP BY MT_YN, MAIN_LOT_NO, SUB_LOT_NO, ROAD_NM_CD, BASEMENT_YN, MAIN_BLD_NO, SUB_BLD_NO, CITY_PUBLIC_BLD_NM
);

/****** Object:  Table [dbo].[EM_ADR_BLD_INFO_B]    Script Date: 2015/08/24 11:48 실제 주소 테이블  ******/
--DROP TABLE EM_ADR_BLD_INFO_B_ALL CASCADE CONSTRAINT PURGE;
/** CREATE TABLE EM_ADR_BLD_INFO_B(
LOW_TOWN_CD VARCHAR2(10) NOT NULL,
MT_YN CHAR(1),
MAIN_LOT_NO NUMBER,
SUB_LOT_NO NUMBER,
ROAD_NM_CD VARCHAR2(12),
BASEMENT_YN CHAR(1),
MAIN_BLD_NO NUMBER,
SUB_BLD_NO NUMBER,
BLD_MNG_NO VARCHAR2(25) NOT NULL,
ZIP_NO VARCHAR2(10),
CITY_PUBLIC_BLD_NM VARCHAR2(200),
APT_HOURSE_YN CHAR(1),
DFT_ZONE_NO VARCHAR2(5)
)
*/
-- AL32UTF8 ==> date length 변경
CREATE TABLE EM_ADR_BLD_INFO_B(
LOW_TOWN_CD VARCHAR2(10) NOT NULL,
MT_YN VARCHAR2(5),
MAIN_LOT_NO NUMBER,
SUB_LOT_NO NUMBER,
ROAD_NM_CD VARCHAR2(25),
BASEMENT_YN VARCHAR2(5),
MAIN_BLD_NO NUMBER,
SUB_BLD_NO NUMBER,
BLD_MNG_NO VARCHAR2(25) NOT NULL,
ZIP_NO VARCHAR2(10),
CITY_PUBLIC_BLD_NM VARCHAR2(300),
APT_HOURSE_YN VARCHAR2(5),
DFT_ZONE_NO VARCHAR2(5)
)
TABLESPACE TS_GW_ZP
STORAGE (INITIAL 1000M NEXT 50M MAXEXTENTS UNLIMITED)
LOGGING
NOPARALLEL;

CREATE UNIQUE INDEX PK_EM_ADR_BLD_INFO_B ON EM_ADR_BLD_INFO_B
(
    BLD_MNG_NO ASC
)
TABLESPACE TS_GW_ZP
LOGGING
NOPARALLEL;

-- PK
ALTER TABLE EM_ADR_BLD_INFO_B ADD (CONSTRAINT PK_EM_ADR_BLD_INFO_B PRIMARY KEY (BLD_MNG_NO));


COMMENT ON TABLE EM_ADR_BLD_INFO_B IS '건물정보기본';
COMMENT ON COLUMN EM_ADR_BLD_INFO_B.LOW_TOWN_CD IS '법정동코드';
COMMENT ON COLUMN EM_ADR_BLD_INFO_B.MT_YN IS '산여부';
COMMENT ON COLUMN EM_ADR_BLD_INFO_B.MAIN_LOT_NO IS '지번본번(번지)';
COMMENT ON COLUMN EM_ADR_BLD_INFO_B.SUB_LOT_NO IS '지번부번(호)';
COMMENT ON COLUMN EM_ADR_BLD_INFO_B.ROAD_NM_CD IS '도로명코드';
COMMENT ON COLUMN EM_ADR_BLD_INFO_B.BASEMENT_YN IS '지하여부';
COMMENT ON COLUMN EM_ADR_BLD_INFO_B.MAIN_BLD_NO IS '건물본번';
COMMENT ON COLUMN EM_ADR_BLD_INFO_B.SUB_BLD_NO IS '건물부번';
COMMENT ON COLUMN EM_ADR_BLD_INFO_B.BLD_MNG_NO IS '건물관리번호';
COMMENT ON COLUMN EM_ADR_BLD_INFO_B.ZIP_NO IS '우편번호';
COMMENT ON COLUMN EM_ADR_BLD_INFO_B.CITY_PUBLIC_BLD_NM IS '시군구용 건물명';
COMMENT ON COLUMN EM_ADR_BLD_INFO_B.APT_HOURSE_YN IS '공동주택여부';
COMMENT ON COLUMN EM_ADR_BLD_INFO_B.DFT_ZONE_NO IS '기초구역번호';

/****** Object:  Table EM_ADR_GUGUN_B    Script Date: 2015/08/26 15:26 ******/
--DROP TABLE EM_ADR_GUGUN_B CASCADE CONSTRAINT PURGE;
CREATE TABLE EM_ADR_GUGUN_B(
GUGUN_CD VARCHAR2(5) NOT NULL,
SIDO VARCHAR2(80) NOT NULL,
GUGUN VARCHAR2(80)
)
TABLESPACE TS_GW_ZP
STORAGE (INITIAL 1M NEXT 1M MAXEXTENTS UNLIMITED)
LOGGING
NOPARALLEL;

CREATE UNIQUE INDEX PK_EM_ADR_GUGUN_B ON EM_ADR_GUGUN_B
(
    GUGUN_CD ASC
)
TABLESPACE TS_GW_ZP
LOGGING
NOPARALLEL;

ALTER TABLE EM_ADR_GUGUN_B ADD 
(CONSTRAINT PK_EM_ADR_GUGUN_B PRIMARY KEY (GUGUN_CD));

COMMENT ON COLUMN EM_ADR_GUGUN_B.GUGUN_CD IS '시군구코드';
COMMENT ON COLUMN EM_ADR_GUGUN_B.SIDO IS '시도명';
COMMENT ON COLUMN EM_ADR_GUGUN_B.GUGUN IS '시군구명';
COMMENT ON TABLE EM_ADR_GUGUN_B IS '시군구기본';

-- 데이터 삽입
--DELETE FROM EM_ADR_GUGUN_B
INSERT INTO EM_ADR_GUGUN_B
SELECT SUBSTR(ROAD_NM_CD,1,5) AS GUGUN_CD, SIDO, GUGUN
FROM EM_ADR_BLD_INFO_B_GROUP
GROUP BY SUBSTR(ROAD_NM_CD,1,5), SIDO, GUGUN;
COMMIT;

/****** Object:  Table EM_ADR_ROAD_B    Script Date: 2015/08/27 10:59 ******/
--DROP TABLE EM_ADR_ROAD_B CASCADE CONSTRAINT PURGE;
CREATE TABLE EM_ADR_ROAD_B(
ROAD_NM_CD VARCHAR2(25) NOT NULL,
ROAD_NM VARCHAR2(120) NOT NULL
)
TABLESPACE TS_GW_ZP
STORAGE (INITIAL 10M NEXT 5M MAXEXTENTS UNLIMITED)
LOGGING
NOPARALLEL;

CREATE UNIQUE INDEX PK_EM_ADR_ROAD_B ON EM_ADR_ROAD_B
(
    ROAD_NM_CD ASC
)
TABLESPACE TS_GW_ZP
LOGGING
NOPARALLEL;

ALTER TABLE EM_ADR_ROAD_B ADD (CONSTRAINT PK_EM_ADR_ROAD_B PRIMARY KEY (ROAD_NM_CD));

COMMENT ON COLUMN EM_ADR_ROAD_B.ROAD_NM_CD IS '도로명코드';
COMMENT ON COLUMN EM_ADR_ROAD_B.ROAD_NM IS '도로명';
COMMENT ON TABLE EM_ADR_ROAD_B IS '도로기본';

-- INDEX
--CREATE INDEX IDX_EM_ADR_ROAD_B ON EM_ADR_ROAD_B
--(
 --   ROAD_NM
--)
--TABLESPACE TS_GW_ZP
--LOGGING
--NOPARALLEL;

-- 데이터 삽입
--DELETE FROM EM_ADR_ROAD_B
INSERT INTO EM_ADR_ROAD_B
SELECT ROAD_NM_CD, ROAD_NM
FROM EM_ADR_BLD_INFO_B_GROUP
GROUP BY ROAD_NM_CD, ROAD_NM;
COMMIT;

/****** Object:  Table EM_ADR_DONG_B    Script Date: 2015/08/27 10:59 ******/
--DROP TABLE EM_ADR_DONG_B CASCADE CONSTRAINT PURGE;
CREATE TABLE EM_ADR_DONG_B(
LOW_TOWN_CD VARCHAR2(10) NOT NULL,
DONG VARCHAR2(80) NOT NULL,
RI VARCHAR2(80)
)
TABLESPACE TS_GW_ZP
STORAGE (INITIAL 1M NEXT 1M MAXEXTENTS UNLIMITED)
LOGGING
NOPARALLEL;

CREATE UNIQUE INDEX PK_EM_ADR_DONG_B ON EM_ADR_DONG_B
(
    LOW_TOWN_CD ASC
)
TABLESPACE TS_GW_ZP
LOGGING
NOPARALLEL;

ALTER TABLE EM_ADR_DONG_B ADD (CONSTRAINT PK_EM_ADR_DONG_B PRIMARY KEY (LOW_TOWN_CD));

COMMENT ON COLUMN EM_ADR_DONG_B.LOW_TOWN_CD IS '법정동코드';
COMMENT ON COLUMN EM_ADR_DONG_B.DONG IS '법정읍면동명';
COMMENT ON COLUMN EM_ADR_DONG_B.RI IS '법정리명';
COMMENT ON TABLE EM_ADR_DONG_B IS '동기본';

-- 데이터 삽입
--DELETE FROM EM_ADR_DONG_B
INSERT INTO EM_ADR_DONG_B
SELECT LOW_TOWN_CD, DONG, RI
FROM EM_ADR_BLD_INFO_B_GROUP
GROUP BY LOW_TOWN_CD, DONG, RI;
COMMIT;

-- 데이터 최종 복사
INSERT INTO EM_ADR_BLD_INFO_B (LOW_TOWN_CD, MT_YN, MAIN_LOT_NO, 
   SUB_LOT_NO, ROAD_NM_CD, BASEMENT_YN, 
   MAIN_BLD_NO, SUB_BLD_NO, BLD_MNG_NO, 
   ZIP_NO, CITY_PUBLIC_BLD_NM, APT_HOURSE_YN, 
   DFT_ZONE_NO)
SELECT LOW_TOWN_CD, MT_YN, MAIN_LOT_NO, 
   SUB_LOT_NO, ROAD_NM_CD, BASEMENT_YN, 
   MAIN_BLD_NO, SUB_BLD_NO, BLD_MNG_NO, 
   ZIP_NO, CITY_PUBLIC_BLD_NM, APT_HOURSE_YN, 
   DFT_ZONE_NO
FROM EM_ADR_BLD_INFO_B_GROUP;  
COMMIT;

-- INDEX
--DROP INDEX IDX_EM_ADR_BLD_INFO_B_1;

CREATE INDEX IDX_EM_ADR_BLD_INFO_B_1 ON EM_ADR_BLD_INFO_B(ROAD_NM_CD,MAIN_BLD_NO)
TABLESPACE TS_GW_ZP
LOGGING
NOPARALLEL;

CREATE INDEX IDX_EM_ADR_BLD_INFO_B_2 ON EM_ADR_BLD_INFO_B(LOW_TOWN_CD)
TABLESPACE TS_GW_ZP
LOGGING
NOPARALLEL;


CREATE INDEX IDX_EM_ADR_BLD_INFO_B ON EM_ADR_BLD_INFO_B
(
    LOW_TOWN_CD,MAIN_LOT_NO,ROAD_NM_CD,MAIN_BLD_NO,CITY_PUBLIC_BLD_NM
)
TABLESPACE TS_GW_ZP
LOGGING
NOPARALLEL;

-- 변환전 데이터 : 1991632 KB - 전체(ALL) EM_ADR_BLD_INFO_B_ALL
-- 변환전 데이터 : 1147992KB - 건물상세제외(GROUP) EM_ADR_BLD_INFO_B_GROUP 
-- 변환후 데이터 : 623632 KB - 불필요한 컬럼 제외(최종) EM_ADR_BLD_INFO_B

-- 기존 우편번호 테이블 삭제
--DROP TABLE PT_ZIPCD_B CASCADE CONSTRAINT PURGE
--DROP TABLE PT_ZIPCD_DFT_B CASCADE CONSTRAINT PURGE

-- 주소그룹 테이블 삭제
DROP TABLE EM_ADR_BLD_INFO_B_ALL CASCADE CONSTRAINT PURGE;
DROP TABLE EM_ADR_BLD_INFO_B_GROUP CASCADE CONSTRAINT PURGE;

--DROP TABLE EM_ADR_BLD_INFO_B CASCADE CONSTRAINT PURGE;
--DROP TABLE EM_ADR_BLD_INFO_B_GROUP CASCADE CONSTRAINT PURGE;
--DROP TABLE EM_ADR_DONG_B CASCADE CONSTRAINT PURGE;
--DROP TABLE EM_ADR_GUGUN_B CASCADE CONSTRAINT PURGE;
--DROP TABLE EM_ADR_ROAD_B CASCADE CONSTRAINT PURGE;
--DROP TABLE EM_ADR_BLD_INFO_B_ALL CASCADE CONSTRAINT PURGE;
