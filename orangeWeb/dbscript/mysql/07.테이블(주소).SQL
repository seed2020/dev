/****** Object:  Table [dbo].[EM_ADR_BLD_INFO_B_ALL]    Script Date: 2015/08/24 11:48 - 주소전체 : 가공을 위한 전체 데이터 ******/
--DROP TABLE EM_ADR_BLD_INFO_B_ALL CASCADE CONSTRAINTS;
-- AL32UTF8 ==> date length 변경
CREATE TABLE EM_ADR_BLD_INFO_B_ALL(
LOW_TOWN_CD VARCHAR(20) NOT NULL,
SIDO VARCHAR(80) NOT NULL,
GUGUN VARCHAR(80),
DONG VARCHAR(80) NULL,
RI VARCHAR(80),
MT_YN VARCHAR(5),
MAIN_LOT_NO INT,
SUB_LOT_NO INT,
ROAD_NM_CD VARCHAR(25),
ROAD_NM VARCHAR(120),
BASEMENT_YN VARCHAR(5),
MAIN_BLD_NO INT,
SUB_BLD_NO INT,
BLD_NM VARCHAR(80),
BLD_DETL_NM VARCHAR(200),
BLD_MNG_NO VARCHAR(25) NOT NULL,
DONG_SEQ VARCHAR(10) NOT NULL,
GOV_TOWN_CD VARCHAR(15),
GOV_TOWN_NM VARCHAR(40),
ZIP_NO VARCHAR(10),
ZIP_SEQ VARCHAR(3),
BULK_DELIVERY_NM VARCHAR(80),
MOVE_REASON_CD VARCHAR(5),
NOTICE_YMD VARCHAR(25),
BEFORE_ROAD_ADR VARCHAR(25),
CITY_PUBLIC_BLD_NM VARCHAR(300),
APT_HOURSE_YN VARCHAR(5),
DFT_ZONE_NO VARCHAR(5),
DETL_ADR_YN CHAR(5),
NOTE1 VARCHAR(30),
NOTE2 VARCHAR(30)
);

-- 임시테이블에 중복제거 주소데이터 저장
--DROP TABLE EM_ADR_BLD_INFO_B_GROUP
CREATE TABLE EM_ADR_BLD_INFO_B_GROUP AS 
SELECT * FROM  EM_ADR_BLD_INFO_B_ALL 
WHERE BLD_MNG_NO IN(
	SELECT MIN(BLD_MNG_NO) BLD_MNG_NO
	FROM EM_ADR_BLD_INFO_B_ALL
	GROUP BY MT_YN, MAIN_LOT_NO, SUB_LOT_NO, ROAD_NM_CD, BASEMENT_YN, MAIN_BLD_NO, SUB_BLD_NO, CITY_PUBLIC_BLD_NM
);

/*
CREATE TABLE EM_ADR_BLD_INFO_B(
LOW_TOWN_CD VARCHAR(20) NOT NULL    COMMENT '법정동코드',
MT_YN VARCHAR(5)    COMMENT '산여부',
MAIN_LOT_NO INT    COMMENT '지번본번(번지)',
SUB_LOT_NO INT    COMMENT '지번부번(호)',
ROAD_NM_CD VARCHAR(25)    COMMENT '도로명코드',
BASEMENT_YN VARCHAR(5)    COMMENT '지하여부',
MAIN_BLD_NO INT    COMMENT '건물본번',
SUB_BLD_NO INT    COMMENT '건물부번',
BLD_MNG_NO VARCHAR(25) NOT NULL    COMMENT '건물관리번호',
ZIP_NO VARCHAR(10)    COMMENT '우편번호',
CITY_PUBLIC_BLD_NM VARCHAR(300)    COMMENT '시군구용 건물명',
APT_HOURSE_YN VARCHAR(5)    COMMENT '공동주택여부',
DFT_ZONE_NO VARCHAR(5)	 COMMENT '기초구역번호'
)
COMMENT = '건물정보기본';

CREATE UNIQUE INDEX PK_EM_ADR_BLD_INFO_B ON EM_ADR_BLD_INFO_B
(
    BLD_MNG_NO ASC
);

-- PK
ALTER TABLE EM_ADR_BLD_INFO_B ADD (CONSTRAINT PK_EM_ADR_BLD_INFO_B PRIMARY KEY (BLD_MNG_NO));
*/

/****** Object:  Table EM_ADR_GUGUN_B    Script Date: 2015/08/26 15:26 ******/
/*
--DROP TABLE EM_ADR_GUGUN_B CASCADE CONSTRAINTS;
CREATE TABLE EM_ADR_GUGUN_B(
GUGUN_CD VARCHAR(5) NOT NULL	COMMENT '시군구코드',
SIDO VARCHAR(80) NOT NULL	COMMENT '시도명',
GUGUN VARCHAR(80)	COMMENT '시군구명'
)
COMMENT = '시군구기본';

CREATE UNIQUE INDEX PK_EM_ADR_GUGUN_B ON EM_ADR_GUGUN_B
(
    GUGUN_CD ASC
);

ALTER TABLE EM_ADR_GUGUN_B ADD 
(CONSTRAINT PK_EM_ADR_GUGUN_B PRIMARY KEY (GUGUN_CD));
*/

-- 데이터 삽입
--DELETE FROM EM_ADR_GUGUN_B
INSERT INTO EM_ADR_GUGUN_B
SELECT SUBSTR(ROAD_NM_CD,1,5) AS GUGUN_CD, SIDO, GUGUN
FROM EM_ADR_BLD_INFO_B_GROUP
GROUP BY SUBSTR(ROAD_NM_CD,1,5), SIDO, GUGUN;
COMMIT;

/****** Object:  Table EM_ADR_ROAD_B    Script Date: 2015/08/27 10:59 ******/
--DROP TABLE EM_ADR_ROAD_B CASCADE CONSTRAINTS;
/*
CREATE TABLE EM_ADR_ROAD_B(
ROAD_NM_CD VARCHAR(25) NOT NULL    COMMENT '도로명코드',
ROAD_NM VARCHAR(120) NOT NULL	   COMMENT '도로명'
)
COMMENT = '도로기본';
CREATE UNIQUE INDEX PK_EM_ADR_ROAD_B ON EM_ADR_ROAD_B
(
    ROAD_NM_CD ASC
);

ALTER TABLE EM_ADR_ROAD_B ADD (CONSTRAINT PK_EM_ADR_ROAD_B PRIMARY KEY (ROAD_NM_CD));
*/

-- INDEX
--CREATE INDEX IDX_EM_ADR_ROAD_B ON EM_ADR_ROAD_B
--(
 --   ROAD_NM
--)

-- 데이터 삽입
--DELETE FROM EM_ADR_ROAD_B
INSERT INTO EM_ADR_ROAD_B
SELECT ROAD_NM_CD, ROAD_NM
FROM EM_ADR_BLD_INFO_B_GROUP
GROUP BY ROAD_NM_CD, ROAD_NM;
COMMIT;

/****** Object:  Table EM_ADR_DONG_B    Script Date: 2015/08/27 10:59 ******/
--DROP TABLE EM_ADR_DONG_B CASCADE CONSTRAINTS;
/*
CREATE TABLE EM_ADR_DONG_B(
LOW_TOWN_CD VARCHAR(20) NOT NULL    COMMENT '법정동코드',
DONG VARCHAR(80) NOT NULL	COMMENT '법정읍면동명',
RI VARCHAR(80)	   COMMENT '법정리명'
)
COMMENT = '동기본';
CREATE UNIQUE INDEX PK_EM_ADR_DONG_B ON EM_ADR_DONG_B
(
    LOW_TOWN_CD ASC
);

ALTER TABLE EM_ADR_DONG_B ADD (CONSTRAINT PK_EM_ADR_DONG_B PRIMARY KEY (LOW_TOWN_CD));
*/
-- 데이터 삽입
--DELETE FROM EM_ADR_DONG_B
INSERT INTO EM_ADR_DONG_B
SELECT LOW_TOWN_CD, DONG, RI
FROM EM_ADR_BLD_INFO_B_GROUP
GROUP BY LOW_TOWN_CD, DONG, RI;
COMMIT;

-- 데이터 최종 복사
INSERT INTO EM_ADR_BLD_INFO_B (LOW_TOWN_CD, MT_YN, MAIN_LOT_NO, 
   SUB_LOT_NO, ROAD_NM_CD, BASEMENT_YN, 
   MAIN_BLD_NO, SUB_BLD_NO, BLD_MNG_NO, 
   ZIP_NO, CITY_PUBLIC_BLD_NM, APT_HOURSE_YN, 
   DFT_ZONE_NO)
SELECT LOW_TOWN_CD, MT_YN, MAIN_LOT_NO, 
   SUB_LOT_NO, ROAD_NM_CD, BASEMENT_YN, 
   MAIN_BLD_NO, SUB_BLD_NO, BLD_MNG_NO, 
   ZIP_NO, CITY_PUBLIC_BLD_NM, APT_HOURSE_YN, 
   DFT_ZONE_NO
FROM EM_ADR_BLD_INFO_B_GROUP;  
COMMIT;


-- INDEX
-- ALTER TABLE EM_ADR_BLD_INFO_B DROP INDEX IDX_EM_ADR_BLD_INFO_B
CREATE INDEX IDX_EM_ADR_BLD_INFO_B_1 ON EM_ADR_BLD_INFO_B(ROAD_NM_CD, MAIN_BLD_NO);
CREATE INDEX IDX_EM_ADR_BLD_INFO_B_2 ON EM_ADR_BLD_INFO_B(LOW_TOWN_CD);

-- 전체(ALL) EM_ADR_BLD_INFO_B_ALL
-- 건물상세제외(GROUP) EM_ADR_BLD_INFO_B_GROUP 
-- 불필요한 컬럼 제외(최종) EM_ADR_BLD_INFO_B

-- 기존 우편번호 테이블 삭제
--DROP TABLE PT_ZIPCD_B CASCADE CONSTRAINTS;
--DROP TABLE PT_ZIPCD_DFT_B CASCADE CONSTRAINTS;

-- 주소그룹 테이블 삭제
DROP TABLE EM_ADR_BLD_INFO_B_ALL;
DROP TABLE EM_ADR_BLD_INFO_B_GROUP;

--DROP TABLE EM_ADR_BLD_INFO_B;
--DROP TABLE EM_ADR_BLD_INFO_B_GROUP;
--DROP TABLE EM_ADR_DONG_B;
--DROP TABLE EM_ADR_GUGUN_B;
--DROP TABLE EM_ADR_ROAD_B;
--DROP TABLE EM_ADR_BLD_INFO_B_ALL;
