<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- TABLE : SH_AP_IDX_B[인덱스결재기본] -->
<mapper namespace="com.innobiz.orange.web.sh.dao.ShSrshDao">

	<resultMap id="shSrchVoMap" type="ShSrchVo">
		<id property="idxNo" column="IDX_NO" /><!-- 인덱스번호 -->
		<result property="mdRid" column="MD_RID" /><!-- 모듈참조ID -->
		<result property="mdBxId" column="MD_BX_ID" /><!-- 모듈함ID -->
		<result property="mdBxNm" column="MD_BX_NM" /><!-- 모듈함명 -->
		<result property="mdId" column="MD_ID" /><!-- 모듈ID -->
		<result property="subj" column="SUBJ" /><!-- 제목 -->
		<result property="regrUid" column="REGR_UID" /><!-- 작성자UID -->
		<result property="regrNm" column="REGR_NM" /><!-- 작성자명 -->
		<result property="regDt" column="REG_DT" /><!-- 작성일 -->
		<result property="url" column="URL" /><!-- URL -->
		<result property="rnum" column="RNUM" /><!-- 레코드 번호 -->
		<result property="cnt" column="CNT" /><!-- 수 -->
		<result property="smry" column="SMRY" /><!-- 요약 -->
	</resultMap>

	<sql id="searchWhere">
		<where>
			<if test="kwdList != null">
			T.IDX_NO IN (
				SELECT S0.IDX_NO
				FROM <foreach collection="kwdList" item="item" index="index" separator=",">GW_SEARCH_USER.SHX_${item.partiNo}_D S${index}</foreach>
				WHERE
				<foreach collection="kwdList" item="item" index="index" separator="">
					<if test="index == 0">
						S0.KWD LIKE #{item.kwd}||'%'
						<if test="subjYn or bodyYn or attchYn">
						AND (<trim prefixOverrides="OR"><if test="subjYn">OR S0.SUBJ_YN = 'Y'</if><if test="bodyYn">OR S0.BODY_YN = 'Y'</if><if test="attchYn">OR S0.ATT_YN = 'Y'</if></trim>)
						</if>
					</if>
					<if test="index != 0">
						AND S0.IDX_NO = S${index}.IDX_NO
						AND S${index}.KWD LIKE #{item.kwd}||'%'
						<if test="subjYn or bodyYn or attchYn">
						AND (<trim prefixOverrides="OR"><if test="subjYn">OR S${index}.SUBJ_YN = 'Y'</if><if test="bodyYn">OR S${index}.BODY_YN = 'Y'</if><if test="attchYn">OR S${index}.ATT_YN = 'Y'</if></trim>)
						</if>
					</if>
				</foreach>
			)</if>
			AND (
				<if test="mdRid == 'BB'">
				T.NO_AUTH_YN = 'Y'
				OR EXISTS (SELECT 1 FROM GW_SEARCH_USER.SH_${mdRid}_AUTH_D USR WHERE T.IDX_NO = USR.IDX_NO AND USR.AUTH_TYP_CD = 'user'
					AND USR.AUTH_CD = #{userUid, jdbcType=VARCHAR})
				OR EXISTS (SELECT 1 FROM GW_SEARCH_USER.SH_${mdRid}_AUTH_D DPT WHERE T.IDX_NO = DPT.IDX_NO AND DPT.AUTH_TYP_CD = 'dept'
					AND DPT.AUTH_CD = #{deptId, jdbcType=VARCHAR})
				OR EXISTS (SELECT 1 FROM GW_SEARCH_USER.SH_${mdRid}_AUTH_D SDPT WHERE T.IDX_NO = SDPT.IDX_NO AND SDPT.AUTH_TYP_CD = 'deptSub'
					AND SDPT.AUTH_CD IN (<foreach collection="subDeptList" item="subItem" separator=",">#{subItem}</foreach>))
				</if>
				<if test="mdRid == 'AP'">
				EXISTS (SELECT 1 FROM GW_SEARCH_USER.SH_${mdRid}_AUTH_D USR WHERE T.IDX_NO = USR.IDX_NO AND USR.AUTH_TYP_CD = 'user'
					AND USR.AUTH_CD = #{userUid, jdbcType=VARCHAR})
				OR (
					EXISTS (SELECT 1 FROM GW_SEARCH_USER.SH_${mdRid}_AUTH_D DPT WHERE T.IDX_NO = DPT.IDX_NO AND DPT.AUTH_TYP_CD = 'dept'
						AND DPT.AUTH_CD IN ('NO_DEPT', #{deptId, jdbcType=VARCHAR}))
					<if test="seculCdList != null">
						<if test="seculAplyMdBxIdList == null">
					AND T.SECUL_CD IN (<foreach collection="seculCdList" item="item" index="index" separator=",">#{item}</foreach>)
						</if>
						<if test="seculAplyMdBxIdList != null">
					AND (
						T.SECUL_CD IN (<foreach collection="seculCdList" item="item" index="index" separator=",">#{item}</foreach>)
						OR (
							T.MD_BX_ID IS NOT NULL
							AND T.MD_BX_ID NOT IN (<foreach collection="seculAplyMdBxIdList" item="item" index="index" separator=",">#{item}</foreach>)
						)
					)
						</if>
					</if>
				)
				</if>
				<if test="mdRid == 'DM'">
				EXISTS (SELECT 1 FROM GW_SEARCH_USER.SH_${mdRid}_AUTH_D USR WHERE T.IDX_NO = USR.IDX_NO AND USR.AUTH_TYP_CD = 'user'
					AND USR.AUTH_CD = #{userUid, jdbcType=VARCHAR})
				OR (
					EXISTS (SELECT 1 FROM GW_SEARCH_USER.SH_${mdRid}_AUTH_D DPT WHERE T.IDX_NO = DPT.IDX_NO AND DPT.AUTH_TYP_CD = 'dept'
						AND DPT.AUTH_CD IN ('NO_DEPT', #{deptId, jdbcType=VARCHAR}))
					<if test="seculCdList != null">
					AND T.SECUL_CD IN (<foreach collection="seculCdList" item="item" index="index" separator=",">#{item}</foreach>)
					</if>
				)
				</if>
			)
			<if test="mdRid == 'BB'">AND (T.EXPR_YMD IS NULL OR T.EXPR_YMD &gt; SYSDATE)</if>
			<if test="mdBxId != null">AND T.MD_BX_ID = #{mdBxId}</if>
			<if test="mdBxIdList != null">
			AND T.MD_BX_ID IN (<foreach collection="mdBxIdList" item="item" index="index" separator=",">#{item}</foreach>)
			</if>
		</where>
	</sql>

	<select id="selectShSrch" resultMap="shSrchVoMap" parameterType="ShSrchVo" >
		/* com.innobiz.orange.web.sh.dao.ShSrshDao.selectShSrch */
		<if test="pageNo != null and pageRowCnt != null">
		SELECT
		<trim prefix="" suffix="" suffixOverrides=",">
			M.*,
			(SELECT RESC_VA FROM GW_SEARCH_USER.SH_${mdRid}_RESC_D R WHERE R.IDX_NO = M.IDX_NO AND R.RESC_ID='MD_BX_NM' AND R.LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR},'ko')) MD_BX_NM,
			CASE WHEN M.MD_BX_ID IN ('recvRecLst', 'distRecLst')
				THEN (SELECT RESC_VA FROM GW_SEARCH_USER.SH_${mdRid}_RESC_D R WHERE R.IDX_NO = M.IDX_NO AND R.RESC_ID='DEPT_NM' AND R.LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR},'ko'))
				ELSE (SELECT RESC_VA FROM GW_SEARCH_USER.SH_${mdRid}_RESC_D R WHERE R.IDX_NO = M.IDX_NO AND R.RESC_ID='REGR_NM' AND R.LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR},'ko'))
			END REGR_NM,
		</trim>
		FROM (
		</if>
		SELECT
		<trim prefix="" suffix="" suffixOverrides=",">
			<if test="pageNo != null and pageRowCnt != null">
			* FROM (SELECT N.*, ROWNUM RNUM FROM (SELECT
			</if>
			T.IDX_NO,
			T.MD_RID,
			T.MD_BX_ID,
			T.MD_ID,
			T.SUBJ,
			T.REGR_UID,
			TO_CHAR(T.REG_DT, 'YYYY-MM-DD HH24:MI:SS') REG_DT,
			T.URL,
			T.SMRY,
			<if test="pageNo == null or pageRowCnt == null">
			(SELECT RESC_VA FROM GW_SEARCH_USER.SH_${mdRid}_RESC_D R WHERE R.IDX_NO = T.IDX_NO AND R.RESC_ID='MD_BX_NM' AND R.LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR},'ko')) MD_BX_NM,
			CASE WHEN M.MD_BX_ID IN ('recvRecLst', 'distRecLst')
				THEN (SELECT RESC_VA FROM GW_SEARCH_USER.SH_${mdRid}_RESC_D R WHERE R.IDX_NO = M.IDX_NO AND R.RESC_ID='DEPT_NM' AND R.LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR},'ko'))
				ELSE (SELECT RESC_VA FROM GW_SEARCH_USER.SH_${mdRid}_RESC_D R WHERE R.IDX_NO = M.IDX_NO AND R.RESC_ID='REGR_NM' AND R.LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR},'ko'))
			END REGR_NM,
			</if>
		</trim>
		FROM GW_SEARCH_USER.SH_${mdRid}_IDX_B T
		<include refid="searchWhere"/>
		<if test="orderBy != null">ORDER BY ${orderBy}</if>
		<if test="orderBy == null">ORDER BY T.IDX_NO</if>
		<if test="pageNo != null and pageRowCnt != null">
		<![CDATA[) N WHERE ROWNUM <= #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}) WHERE RNUM > (#{pageNo, jdbcType=NUMERIC} - 1) * #{pageRowCnt, jdbcType=NUMERIC}]]> ) M
		</if>
	</select>
	
	<select id="countShSrchByMdBx" resultMap="shSrchVoMap" parameterType="ShSrchVo" >
		/* com.innobiz.orange.web.sh.dao.ShSrshDao.countShSrchByMdBx */
		SELECT
			MD_BX_ID,
			(SELECT RESC_VA FROM GW_SEARCH_USER.SH_${mdRid}_RESC_D R WHERE R.IDX_NO = M.IDX_NO AND R.RESC_ID='MD_BX_NM' AND R.LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR},'ko')) MD_BX_NM,
			CNT
		FROM (
			SELECT
				T.MD_BX_ID,
				MAX(T.IDX_NO) IDX_NO,
				COUNT(T.IDX_NO) CNT
			FROM GW_SEARCH_USER.SH_${mdRid}_IDX_B T
			<include refid="searchWhere"/>
			GROUP BY MD_BX_ID
		) M
		ORDER BY MD_BX_NM
	</select>

</mapper>