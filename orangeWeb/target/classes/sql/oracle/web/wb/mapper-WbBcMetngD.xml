<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- TABLE : WB_BC_METNG_D[명함미팅상세] -->
<mapper namespace="com.innobiz.orange.web.wb.dao.WbBcMetngDDao">

	<resultMap id="wbBcMetngDMap" type="WbBcMetngDVo">
		<id property="compId" column="COMP_ID" /><!-- 회사ID -->
		<id property="regrUid" column="REGR_UID" /><!-- 등록자UID -->		
		<id property="bcMetngDetlId" column="BC_METNG_DETL_ID" /><!-- 명함미팅상세ID -->
		<result property="bcId" column="BC_ID" /><!-- 명함ID -->
		<result property="agnYn" column="AGN_YN" /><!-- 대리여부 -->
		<result property="metngYmd" column="METNG_YMD" /><!-- 미팅년월일 -->
		<result property="openYn" column="OPEN_YN" /><!-- 공개여부 -->
		<result property="rnum" column="RNUM" /><!-- 레코드 번호 -->
		<result property="metngClsCd" column="METNG_CLS_CD" /><!-- 미팅분류코드 -->
		<result property="metngSubj" column="METNG_SUBJ" /><!-- 미팅제목 -->
		<result property="metngCont" column="METNG_CONT" /><!-- 미팅내용 -->
		<result property="attFileId" column="ATT_FILE_ID" /><!-- 첨부파일ID -->
		<result property="readCnt" column="READ_CNT" /><!-- 조회수 -->
		<result property="regDt" column="REG_DT" /><!-- 등록일시 -->
		<result property="bcNm" column="BC_NM" /><!-- 명함성명 -->
		<result property="compNm" column="COMP_NM" /><!-- 회사명 -->
		<result property="regrNm" column="REGR_NM" /><!-- 등록자명 -->
		<result property="metngClsNm" column="METNG_CLS_NM" /><!-- 미팅분류명 -->
		<result property="fileCnt" column="FILE_CNT" /><!-- 첨부파일갯수 -->
		
	</resultMap>
	
	<!-- 조회조건 -->
	<sql id="selectWbBcMetngDWhere">
		<where>
			<if test="compId != null and compId !=''"> AND WBM_T.COMP_ID = #{compId, jdbcType=VARCHAR}</if>
			<if test="regrUid != null and regrUid !=''"> AND WBM_T.REGR_UID = #{regrUid, jdbcType=VARCHAR}</if>
			<if test="bcMetngDetlId != null and bcMetngDetlId !=''"> AND WBM_T.BC_METNG_DETL_ID = #{bcMetngDetlId, jdbcType=VARCHAR}</if>
			<if test="bcId != null and bcId !=''"> AND WBM_T.BC_ID = #{bcId, jdbcType=VARCHAR}</if>
			<if test="'metngSubj'.equals(schCat) and schWord != null and schWord != ''">AND WBM_T.METNG_SUBJ LIKE '%'||#{schWord, jdbcType=VARCHAR}||'%'</if>
			<if test="'metngCont'.equals(schCat) and schWord != null and schWord != ''">AND WBM_T.METNG_CONT LIKE '%'||#{schWord, jdbcType=VARCHAR}||'%'</if>
			<if test="'regrUid'.equals(schCat) and schWord != null and schWord != ''">AND OU_T.USER_NM LIKE '%'||#{schWord, jdbcType=VARCHAR}||'%'</if>
			<if test="schOpenYn != null and schOpenYn !=''"> AND WBM_T.OPEN_YN = #{schOpenYn, jdbcType=VARCHAR}</if>
			<!-- 분류코드 -->
			<if test="schMetngClsCd != null and schMetngClsCd !=''"> AND WBM_T.METNG_CLS_CD = #{schMetngClsCd, jdbcType=VARCHAR}</if>
			<if test="metngStrtDt != null and metngStrtDt != ''"><![CDATA[ AND TO_CHAR(WBM_T.METNG_YMD, 'YYYY-MM-DD')  >= #{metngStrtDt, jdbcType=VARCHAR}]]></if>
			<if test="metngEndDt != null and metngEndDt != ''"><![CDATA[ AND TO_CHAR(WBM_T.METNG_YMD, 'YYYY-MM-DD') <= #{metngEndDt, jdbcType=VARCHAR}]]></if>
			<!-- 기간검색 -->
			<if test="'fromYmd'.equals(durCat) and durStrtDt != null and durStrtDt != ''"><![CDATA[ AND TO_CHAR(WBM_T.REG_DT, 'YYYY-MM-DD')  >= #{durStrtDt, jdbcType=VARCHAR}]]></if>
			<if test="'fromYmd'.equals(durCat) and durEndDt != null and durEndDt != ''"><![CDATA[ AND TO_CHAR(WBM_T.REG_DT, 'YYYY-MM-DD') <= #{durEndDt, jdbcType=VARCHAR}]]></if>
			<if test="schRegrUid != null and schRegrUid !=''"> AND WBM_T.REGR_UID = #{schRegrUid, jdbcType=VARCHAR}</if>
			<if test="schBcId != null and schBcId !=''"> AND WBM_T.BC_ID = #{schBcId, jdbcType=VARCHAR}</if>
			<!-- 다중 조회조건(String) -->
			<if test="whereSqllet != null and whereSqllet != ''"> ${whereSqllet}</if>
		</where>
	</sql>
	
	<!-- 목록조회 -->
	<select id="selectWbBcMetngD" resultMap="wbBcMetngDMap" parameterType="WbBcMetngDVo" >
		/* com.innobiz.orange.web.wb.dao.WbBcMetngDDao.selectWbBcMetngD */
		<if test="pageNo != null and pageRowCnt != null">
		SELECT * FROM (
		</if>
		SELECT
		<trim prefix="" suffix="" suffixOverrides=",">
			<if test="pageNo != null and pageRowCnt != null">
			* FROM (SELECT N.*, ROWNUM RNUM FROM (SELECT
			</if>
			WBM_T.COMP_ID , WBM_T.REGR_UID , WBM_T.BC_METNG_DETL_ID , WBM_T.BC_ID , WBM_T.AGN_YN , TO_CHAR(WBM_T.METNG_YMD, 'YYYY-MM-DD') METNG_YMD , WBM_T.OPEN_YN , WBM_T.METNG_CLS_CD , 
		    WBM_T.METNG_SUBJ , WBM_T.METNG_CONT , WBM_T.ATT_FILE_ID , WBM_T.READ_CNT , TO_CHAR(WBM_T.REG_DT, 'YYYY-MM-DD') REG_DT  , 
		    WB_T.BC_NM , WB_T.COMP_NM , 
			(SELECT RESC_VA FROM OR_RESC_B OR_T WHERE RESC_ID = OU_T.RESC_ID  AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR},'ko')) AS REGR_NM ,  
		    (SELECT RESC_VA FROM WM_RESC_B WB_T WHERE RESC_ID = (SELECT RESC_ID FROM WB_METNG_CLS_CD_B WHERE RESC_ID = WBM_T.METNG_CLS_CD) AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR},'ko')) AS METNG_CLS_NM ,
		    (SELECT COUNT(*) FROM WB_BC_METNG_FILE_D WHERE REF_ID = WBM_T.BC_METNG_DETL_ID) FILE_CNT,
		</trim>
		FROM WB_BC_METNG_D WBM_T INNER JOIN OR_USER_B OU_T ON WBM_T.REGR_UID = OU_T.USER_UID
														LEFT OUTER JOIN WB_BC_B WB_T ON WBM_T.BC_ID = WB_T.BC_ID
		<include refid="selectWbBcMetngDWhere"/>
		<if test="orderBy != null">ORDER BY ${orderBy}</if>
		<if test="orderBy == null">ORDER BY TO_CHAR(WBM_T.REG_DT, 'YYYY-MM-DD') DESC </if>
		<if test="pageNo != null and pageRowCnt != null">
		<![CDATA[) N WHERE ROWNUM <= #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}) WHERE RNUM > (#{pageNo, jdbcType=NUMERIC} - 1) * #{pageRowCnt, jdbcType=NUMERIC}]]> ) M
		</if>
	</select>
	
	<!-- 목록조회 건수-->
	<select id="countWbBcMetngD" resultType="Integer" parameterType="WbBcMetngDVo" >
		/* com.innobiz.orange.web.wb.dao.WbBcMetngDDao.countWbBcMetngD */
		SELECT COUNT(*) CNT
		FROM WB_BC_METNG_D WBM_T INNER JOIN OR_USER_B OU_T ON WBM_T.REGR_UID = OU_T.USER_UID
														LEFT OUTER JOIN WB_BC_B WB_T ON WBM_T.BC_ID = WB_T.BC_ID
		<include refid="selectWbBcMetngDWhere"/>
	</select>
		
	<!-- 등록 저장 -->
	<insert id="insertWbBcMetngD" parameterType="WbBcMetngDVo" >
		/* com.innobiz.orange.web.wb.dao.WbBcMetngDDao.insertWbBcMetngD */
		INSERT INTO WB_BC_METNG_D
		<trim prefix="(" suffix=")" suffixOverrides=",">
			COMP_ID , BC_ID , BC_METNG_DETL_ID , AGN_YN , METNG_YMD , OPEN_YN , 
			METNG_CLS_CD , METNG_SUBJ , METNG_CONT , ATT_FILE_ID , READ_CNT , 
			REGR_UID , REG_DT ,
		</trim>
		<trim prefix="VALUES (" suffix=")" suffixOverrides="," >
			#{compId, jdbcType=VARCHAR},#{bcId, jdbcType=VARCHAR},#{bcMetngDetlId, jdbcType=VARCHAR},#{agnYn, jdbcType=VARCHAR},TO_DATE(#{metngYmd, jdbcType=VARCHAR}, 'YYYY-MM-DD HH24:MI:SS') , #{openYn, jdbcType=VARCHAR},
			#{metngClsCd, jdbcType=NVARCHAR},	#{metngSubj, jdbcType=VARCHAR},#{metngCont, jdbcType=VARCHAR},#{attFileId, jdbcType=VARCHAR},0,
			#{regrUid, jdbcType=VARCHAR},
			<if test="regDt == 'sysdate'">SYSDATE,</if><if test="regDt == null or regDt == ''"><if test="modDt == 'sysdate'">SYSDATE,</if><if test="modDt != 'sysdate'">NULL,</if></if>
		</trim>
	</insert>
	
	<!-- 수정 -->
	<update id="updateWbBcMetngD" parameterType="WbBcMetngDVo" >
		/* com.innobiz.orange.web.wb.dao.WbBcMetngDDao.updateWbBcMetngD */
		UPDATE WB_BC_METNG_D
		<set>
			<if test="bcId != null"> BC_ID = #{bcId, jdbcType=VARCHAR},</if>
			<if test="metngYmd != null"> METNG_YMD = TO_DATE(#{metngYmd, jdbcType=VARCHAR}, 'YYYY-MM-DD HH24:MI:SS'),</if>
			<if test="openYn != null"> OPEN_YN = #{openYn, jdbcType=VARCHAR},</if>
			<if test="metngClsCd != null"> METNG_CLS_CD = #{metngClsCd, jdbcType=VARCHAR},</if>
			<if test="metngSubj != null"> METNG_SUBJ = #{metngSubj, jdbcType=VARCHAR},</if>
			<if test="metngCont != null"> METNG_CONT = #{metngCont, jdbcType=VARCHAR},</if>
			<if test="attFileId != null"> ATT_FILE_ID = #{attFileId, jdbcType=VARCHAR},</if>
			<if test="readCnt != null"> READ_CNT = READ_CNT+1,</if>
			<if test="modrUid != null"> MODR_UID = #{modrUid, jdbcType=VARCHAR},</if>
			<if test="modDt != null"> 
				<if test="modDt == 'sysdate'"> MOD_DT = SYSDATE,</if>
				<if test="modDt == ''"> MOD_DT = NULL,</if>
				<if test="modDt != '' and modDt != 'sysdate'"> MOD_DT = TO_DATE(#{modDt, jdbcType=VARCHAR}, 'YYYY-MM-DD HH24:MI:SS'),</if>
			</if>
		</set>
		<where>
			<if test="compId != null and compId !=''"> AND COMP_ID = #{compId, jdbcType=VARCHAR}</if>
			<if test="bcMetngDetlId != null"> AND BC_METNG_DETL_ID = #{bcMetngDetlId, jdbcType=VARCHAR}</if>
			<if test="modrUid != null"> AND REGR_UID = #{modrUid, jdbcType=VARCHAR}</if>
		</where>
	</update>

	<!-- 삭제 -->
	<delete id="deleteWbBcMetngD" parameterType="WbBcMetngDVo" >
		/* com.innobiz.orange.web.wb.dao.WbBcMetngDDao.deleteWbBcMetngD */
		DELETE FROM WB_BC_METNG_D
		<where>
			<if test="compId != null and compId !=''"> AND COMP_ID = #{compId, jdbcType=VARCHAR}</if>
			<if test="bcMetngDetlId != null"> AND BC_METNG_DETL_ID = #{bcMetngDetlId, jdbcType=VARCHAR}</if>
			<if test="regrUid != null"> AND REGR_UID = #{regrUid, jdbcType=VARCHAR}</if>
		</where>
	</delete>

</mapper>