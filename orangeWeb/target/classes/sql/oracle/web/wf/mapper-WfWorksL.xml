<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- TABLE : WF_${테이블ID}_WORKS_L[업무목록] -->
<mapper namespace="com.innobiz.orange.web.wf.dao.WfWorksLDao">

	<resultMap id="wfWorksLMap" type="WfWorksLVo">
		<id property="workNo" column="WORK_NO" /><!-- 양식번호 -->
		<result property="compId" column="COMP_ID" /><!-- 회사ID -->
		<result property="formNo" column="FORM_NO" /><!-- 그룹ID -->
		<result property="genId" column="GEN_ID" /><!-- 생성ID -->
		<result property="jsonVa" column="JSON_VA" /><!-- JSON값 -->
		<result property="loutVa" column="LOUT_VA" /><!-- 레이아웃값 -->
		<result property="attrVa" column="ATTR_VA" /><!-- 속성값 -->
		<result property="regrNm" column="REGR_NM" /><!-- 등록자명 -->
		<result property="regrUid" column="REGR_UID" /><!-- 등록자UID -->
		<result property="regDt" column="REG_DT" /><!-- 등록일시 -->
		<result property="modrUid" column="MODR_UID" /><!-- 수정자 -->
		<result property="modDt" column="MOD_DT" /><!-- 수정일시 -->
		<collection property="voMap" autoMapping="true" resultMap="HashMap"/>
	</resultMap>
	
	
	<!-- 조회조건 -->
	<sql id="selectWfWorksLWhere">
		<where>
			<if test="workNo != null and workNo !=''"> AND T.WORK_NO = #{workNo, jdbcType=VARCHAR}</if>
			<if test="compId != null and compId !=''"> AND T.COMP_ID = #{compId, jdbcType=VARCHAR}</if>
			<if test="formNo != null and formNo !=''"> AND T.FORM_NO = #{formNo, jdbcType=VARCHAR}</if>
			<if test="genId != null and genId !=''"> AND T.GEN_ID = #{genId, jdbcType=VARCHAR}</if>
			 <if test="!isDetail"><if test="statCd != null and statCd !=''"> AND T.STAT_CD = #{statCd, jdbcType=VARCHAR}</if></if>
			<if test="schListMap != null">
				<if test="schListMap['likeText'] != null">
					<foreach item="colms" index="index" collection="schListMap['likeText']" >
		        		AND T.${colms.dbColmNm} LIKE '%' || #{colms.value, jdbcType=${colms.dataTyp}} || '%'
					</foreach>
				</if>
				<if test="schListMap['orLike'] != null">
					<foreach item="colms" index="index" collection="schListMap['orLike']" open="AND(" close=")" >
		        		<if test="index != 0">OR</if> T.${colms.dbColmNm} LIKE '%' || #{colms.value, jdbcType=${colms.dataTyp}} || '%'
					</foreach>
				</if>
				<if test="schListMap['eqText'] != null">
					<foreach item="colms" index="index" collection="schListMap['eqText']" >
		        		AND T.${colms.dbColmNm} = #{colms.value, jdbcType=${colms.dataTyp}}
					</foreach>
				</if>
				<if test="schListMap['strtDtList'] != null">
					<foreach item="colms" index="index" collection="schListMap['strtDtList']" >
		        		<![CDATA[ AND T.${colms.dbColmNm} >= TO_DATE(#{colms.value, jdbcType=${colms.dataTyp}},'YYYY-MM-DD HH24:MI:SS')]]>
					</foreach>
				</if>
				<if test="schListMap['endDtList'] != null">
					<foreach item="colms" index="index" collection="schListMap['endDtList']" >
		        		<![CDATA[ AND T.${colms.dbColmNm} <= TO_DATE(#{colms.value, jdbcType=${colms.dataTyp}},'YYYY-MM-DD HH24:MI:SS')]]>
					</foreach>
				</if>
				<if test="schListMap['eqCode'] != null">
					AND WORK_NO IN(
						SELECT WORK_NO FROM WFG_${formId}_WORKS_CODE_L C
						<where>
						<foreach item="colms" index="index" collection="schListMap['eqCode']" >
							AND C.COLM_NM = #{colms.dbColmNm, jdbcType=VARCHAR}
							<foreach item="item" index="index2" collection="colms['value']" open=" AND C.CD_VA IN(" close=")" separator=",">#{item, jdbcType=VARCHAR}</foreach>
						</foreach>
						</where> 
					)
				</if>
				<if test="schListMap['likeCode'] != null">
					<foreach item="colms" index="index" collection="schListMap['likeCode']" >
						AND(
						<foreach item="item" index="index2" collection="colms['value']" separator="OR">
							T.${colms.dbColmNm} LIKE '%' || #{item, jdbcType=VARCHAR} || '%'</foreach>
						)
					</foreach>
				</if>
			</if>
			<if test="whereSqllet != null and whereSqllet != ''"> ${whereSqllet}</if>
		</where>
	</sql>
	
	<!-- 정렬조건 -->
	<sql id="selectDispOrdr">
		<if test="dispOrdrMap['type']!=null">
			<if test="dispOrdrMap['type']=='user'">(SELECT R.RESC_VA FROM WFG_${formId}_WORKS_CODE_L CL INNER JOIN <if test="dispOrdrMap['type']=='user'">OR_USER_B U ON USER_UID</if><if test="dispOrdrMap['type']=='dept'">OR_ORG_B U ON ORG_ID</if> = CL.CD_VA AND CL.SORT_ORDR=1 AND CL.WORK_NO = T.WORK_NO AND CL.COLM_NM = #{dispOrdrMap.colmNm, jdbcType=VARCHAR}
														        INNER JOIN OR_RESC_B R ON R.RESC_ID = U.RESC_ID AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR}, 'ko')) AS DISP_ORDR,</if>			
			<if test="dispOrdrMap['type']=='code'">(SELECT CD.SORT_ORDR FROM WFG_${formId}_WORKS_CODE_L CL INNER JOIN WF_CD_D CD ON CL.WORK_NO = T.WORK_NO AND CL.SORT_ORDR=1 AND CL.CD_VA = CD.CD_ID AND CL.COLM_NM = #{dispOrdrMap.colmNm, jdbcType=VARCHAR}) AS DISP_ORDR,</if>
		</if>																        														        	
	</sql>
	
	<!-- 조인조건 -->
	<sql id="selectWfWorksLJoin">
	</sql>
	
	<!-- 목록조회 -->
	<select id="selectWfWorksL" resultType="com.innobiz.orange.web.wf.utils.ReturnDataMap" parameterType="WfWorksLVo" >
		/* com.innobiz.orange.web.wf.dao.WfWorksLDao.selectWfWorksL */
		<if test="pageNo != null and pageRowCnt != null">
		SELECT
		<trim prefix="" suffix="" suffixOverrides=",">
			M.*,
			<if test="!isDetail">
			(SELECT READ_CNT FROM WFG_${formId}_WORKS_D D WHERE D.WORK_NO = T.WORK_NO) AS READ_CNT,
			</if>			
		</trim>
		FROM ( SELECT * FROM (
		</if>
		SELECT
		<trim prefix="" suffix="" suffixOverrides=",">
			<if test="pageNo != null and pageRowCnt != null">
			* FROM (SELECT N.*, ROWNUM RNUM FROM (SELECT
			</if>
			T.WORK_NO,
			T.COMP_ID,
	        T.FORM_NO,
	        T.GEN_ID,
	        <if test="!isDetail">
	        T.JSON_VA,
	        T.LOUT_VA,
	        T.ATTR_VA,
	        T.MOB_LOUT_VA,
	        T.MOB_TAB_VA,
	        T.STAT_CD,
	        </if>
	        <if test="isDetail">
	        	<if test="colmList != null">
	        	<foreach item="colmNm" index="index" collection="colmList">
					T.${colmNm[0]},
				</foreach>
				</if>
				<if test="dispOrdrMap != null"><include refid="selectDispOrdr"/></if>
				T.READ_CNT,
	        </if>
	        T.REGR_UID,
	        T.MODR_UID ,
	        (SELECT RESC_VA FROM OR_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM OR_USER_B WHERE USER_UID = T.REGR_UID) AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR}, 'ko')) AS REGR_NM,
			(SELECT RESC_VA FROM OR_RESC_B WHERE RESC_ID = (SELECT RESC_ID FROM OR_USER_B WHERE USER_UID = T.MODR_UID) AND LANG_TYP_CD = NVL(#{queryLang, jdbcType=VARCHAR}, 'ko')) AS MODR_NM,	        
	        TO_CHAR(T.REG_DT,'YYYY-MM-DD HH24:MI:SS') AS REG_DT,
	        TO_CHAR(T.MOD_DT,'YYYY-MM-DD HH24:MI:SS') AS MOD_DT,
		</trim>
		FROM <if test="!isDetail">WFG_${formId}_WORKS_L</if><if test="isDetail">WFG_${formId}_WORKS_D</if> T
		<include refid="selectWfWorksLJoin"/>
		<include refid="selectWfWorksLWhere"/>
		<if test="orderBy != null">ORDER BY ${orderBy}</if>
		<if test="orderBy == null">ORDER BY T.REG_DT DESC</if>
		<if test="pageNo != null and pageRowCnt != null">
		<![CDATA[) N WHERE ROWNUM <= #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}) WHERE RNUM > (#{pageNo, jdbcType=NUMERIC} - 1) * #{pageRowCnt, jdbcType=NUMERIC}]]> ) M ) M
		</if>
	</select>
	
	<!-- 목록조회 건수-->
	<select id="countWfWorksL" resultType="Integer" parameterType="WfWorksLVo" >
		/* com.innobiz.orange.web.wf.dao.WfWorksLDao.countWfWorksL */
		SELECT COUNT(*) CNT
		FROM <if test="!isDetail">WFG_${formId}_WORKS_L</if><if test="isDetail">WFG_${formId}_WORKS_D</if> T
		<include refid="selectWfWorksLWhere"/>
	</select>
	
	<!-- 등록 저장 -->
	<insert id="insertWfWorksL" parameterType="WfWorksLVo" >
		/* com.innobiz.orange.web.wf.dao.WfWorksLDao.insertWfWorksL */
		INSERT INTO <if test="!isDetail">WFG_${formId}_WORKS_L</if><if test="isDetail">WFG_${formId}_WORKS_D</if>
		<trim prefix="(" suffix=")" suffixOverrides=",">
			WORK_NO,
			COMP_ID,
	        FORM_NO,
	        GEN_ID,
	        <if test="!isDetail">
	        JSON_VA,
	        LOUT_VA,
	        ATTR_VA,
	        MOB_LOUT_VA,
	        MOB_TAB_VA,
	        STAT_CD,
	        </if>
	        <if test="isDetail">
	        	<if test="colmList != null">
	        	<foreach item="colmNm" index="index" collection="colmList">
					${colmNm[0]},
				</foreach>
				</if>
	        </if>
	        REGR_UID,
	        REG_DT,
		</trim>
		<trim prefix="VALUES (" suffix=")" suffixOverrides="," >
			#{workNo, jdbcType=INTEGER},
			#{compId, jdbcType=VARCHAR},
			#{formNo, jdbcType=VARCHAR},
			#{genId, jdbcType=VARCHAR},
			<if test="!isDetail">
	        #{jsonVa, jdbcType=VARCHAR},
	        #{loutVa, jdbcType=VARCHAR},
	        #{attrVa, jdbcType=VARCHAR},
	        #{mobLoutVa, jdbcType=VARCHAR},
	        #{mobTabVa, jdbcType=VARCHAR},
	        #{statCd, jdbcType=VARCHAR},
	        </if>
	        <if test="isDetail">
	        	<if test="colmList != null">
	        	<foreach item="colmNm" index="index" collection="colmList">
	        		<if test="voMap[colmNm[1]] == null">NULL,</if>
	        		<if test="voMap[colmNm[1]] == ''">'',</if>
	        		<if test="voMap[colmNm[1]] != null and voMap[colmNm[1]] != ''">#{voMap.${colmNm[1]}, jdbcType=${colmNm[2]}},</if>
				</foreach>
				</if>
	        </if>
			<if test="regrUid != null">#{regrUid, jdbcType=VARCHAR},</if><if test="regrUid == null">NULL,</if>
			<if test="regDt == 'sysdate'">SYSDATE,</if><if test="regDt == null or regDt == ''">NULL,</if>
			<if test="regDt != null and regDt != '' and regDt != 'sysdate'">TO_DATE(#{regDt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS'),</if>
		</trim>
	</insert>
	
	<!-- 수정 -->
	<update id="updateWfWorksL" parameterType="WfWorksLVo" >
		/* com.innobiz.orange.web.wf.dao.WfWorksLDao.updateWfWorksL */
		UPDATE <if test="!isDetail">WFG_${formId}_WORKS_L</if><if test="isDetail">WFG_${formId}_WORKS_D</if>
		<set>
			<if test="formNo != null"> FORM_NO = #{formNo, jdbcType=VARCHAR},</if>
			<if test="genId != null"> GEN_ID = #{genId, jdbcType=VARCHAR},</if>
			<if test="!isDetail">
				<if test="jsonVa != null"> JSON_VA = #{jsonVa, jdbcType=VARCHAR},</if>
				<if test="loutVa != null"> LOUT_VA = #{loutVa, jdbcType=VARCHAR},</if>
				<if test="attrVa != null"> ATTR_VA = #{attrVa, jdbcType=VARCHAR},</if>
				<if test="mobLoutVa != null"> MOB_LOUT_VA = #{mobLoutVa, jdbcType=VARCHAR},</if>
				<if test="mobTabVa != null"> MOB_TAB_VA = #{mobTabVa, jdbcType=VARCHAR},</if>
				<if test="statCd != null"> STAT_CD = #{statCd, jdbcType=VARCHAR},</if>
			</if>
			<if test="isDetail">
				<if test="colmList != null">
	        	<foreach item="colmNm" index="index" collection="colmList">
	        		<if test="voMap[colmNm[1]] != null"> ${colmNm[0]} = <if test="voMap[colmNm[1]] == ''">'',</if><if test="voMap[colmNm[1]] != null and voMap[colmNm[1]] != ''">#{voMap.${colmNm[1]}, jdbcType=${colmNm[2]}},</if>
	        		</if>
				</foreach>
				</if>
				<if test="readCnt != null">
					<if test="readCnt == 'add'"> READ_CNT = NVL(READ_CNT,0)+1,</if>
					<if test="readCnt == ''"> READ_CNT = NULL,</if>
					<if test="readCnt != '' and readCnt != 'add'"> READ_CNT = #{readCnt, jdbcType=INTEGER},</if>
				</if>
	        </if>
			<if test="modrUid != null"> MODR_UID = #{modrUid, jdbcType=VARCHAR},</if>
			<if test="modDt != null"> 
				<if test="modDt == 'sysdate'"> MOD_DT = SYSDATE,</if>
				<if test="modDt == ''"> MOD_DT = NULL,</if>
				<if test="modDt != '' and modDt != 'sysdate'"> MOD_DT = TO_DATE(#{modDt, jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS'),</if>
			</if>
		</set>
		<where>
			<if test="workNo != null and workNo !=''"> AND WORK_NO = #{workNo, jdbcType=VARCHAR}</if>
		</where>
	</update>

	<!-- 삭제 -->
	<delete id="deleteWfWorksL" parameterType="WfWorksLVo" >
		/* com.innobiz.orange.web.wf.dao.WfWorksLDao.deleteWfWorksL */
		DELETE FROM <if test="!isDetail">WFG_${formId}_WORKS_L</if><if test="isDetail">WFG_${formId}_WORKS_D</if>
		<where>
			<if test="workNo != null"> AND WORK_NO = #{workNo, jdbcType=VARCHAR}</if>
		</where>
	</delete>

</mapper>