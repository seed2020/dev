<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!-- TABLE : AP_TRAN_TGT_T[이관대상임시] -->
<mapper namespace="com.innobiz.orange.web.ap.dao.ApxTranDao">

	<resultMap id="apxTranCntMap" type="ApxTranVo">
		<id property="recLstTypCd" column="REC_LST_TYP_CD" /><!-- 대장구분코드 -->
		<result property="cnt" column="CNT" /><!-- 갯수 -->
	</resultMap>

	<!-- 이관 대상 건수 조회 -->
	<select id="selectApxTranCnt" resultMap="apxTranCntMap" parameterType="ApxTranVo" >
		/* com.innobiz.orange.web.ap.dao.ApxTranDao.selectApxTranCnt */
		SELECT REC_LST_TYP_CD, COUNT(APV_NO) CNT
		FROM AP_ONGD_B
		<include refid="apxTranCntWhere"/>
		GROUP BY REC_LST_TYP_CD
	</select>
	
	<!-- 이관 대상 건수 조회 (종이문서)-->
	<select id="selectApxTranPapCnt" resultType="Integer" parameterType="ApxTranVo" >
		/* com.innobiz.orange.web.ap.dao.ApxTranDao.selectApxTranPapCnt */
		SELECT COUNT(APV_NO) CNT
		FROM AP_ONGD_B
		<include refid="apxTranCntWhere"/>
	</select>
	
	<!-- 이관 대상 WHERE (UI 에서 설정한 대상을 찾는 Where 절) -->
	<sql id="apxTranCntWhere">
		WHERE COMP_ID = #{compId, jdbcType=VARCHAR}
		<if test="regRecLstBaseDt == null or recvRecLstBaseDt == null">
			AND REC_LST_TYP_CD IN ('regRecLst','recvRecLst','distRecLst')
		</if>
		<if test="regRecLstBaseDt != null and recvRecLstBaseDt != null">
			AND (
				(REC_LST_TYP_CD = 'regRecLst'
					<if test="durStrtDt != null and durStrtDt != ''"><![CDATA[AND ${regRecLstBaseDt} >= STR_TO_DATE(#{durStrtDt, jdbcType=VARCHAR}, '%Y-%m-%d %H:%i:%s')]]></if>
					<if test="durEndDt != null and durEndDt != ''"><![CDATA[AND ${regRecLstBaseDt} <= STR_TO_DATE(#{durEndDt, jdbcType=VARCHAR}, '%Y-%m-%d %H:%i:%s')]]></if>)
				OR (REC_LST_TYP_CD IN ('recvRecLst', 'distRecLst')
					<if test="durStrtDt != null and durStrtDt != ''"><![CDATA[AND ${recvRecLstBaseDt} >= STR_TO_DATE(#{durStrtDt, jdbcType=VARCHAR}, '%Y-%m-%d %H:%i:%s')]]></if>
					<if test="durEndDt != null and durEndDt != ''"><![CDATA[AND ${recvRecLstBaseDt} <= STR_TO_DATE(#{durEndDt, jdbcType=VARCHAR}, '%Y-%m-%d %H:%i:%s')]]></if>)
			)
		</if>
		<if test="formIdList != null">
			AND FORM_ID IN ( <foreach collection="formIdList" item="item" index="index" separator=",">#{item, jdbcType=VARCHAR}</foreach> )
		</if>
		<if test="whereSqllet != null and whereSqllet != ''">${whereSqllet}</if>
	</sql>
	
	<!-- 2. 이관 대상 추출 -->
	<insert id="extractTransferingData" parameterType="ApxTranVo">
		/* com.innobiz.orange.web.ap.dao.ApxTranDao.extractTransferingData */
		INSERT INTO AP_TRAN_TGT_T (TRAN_ID, TRAN_DATA_TYP_CD, TRAN_SEQ, APV_NO)
		SELECT #{tranId, jdbcType=VARCHAR} TRAN_ID, #{tranDataTypCd, jdbcType=VARCHAR} TRAN_DATA_TYP_CD, ${rnumSql} RNUM, APV_NO
		FROM AP_ONGD_B
		<include refid="apxTranCntWhere"/>
		ORDER BY APV_NO
	</insert>
	
	<!-- 2.1 시행변환 이관 대상 추출 -->
	<insert id="extractTrxTransferingData" parameterType="ApxTranVo">
		/* com.innobiz.orange.web.ap.dao.ApxTranDao.extractTrxTransferingData */
		INSERT INTO AP_TRAN_TGT_T (TRAN_ID, TRAN_DATA_TYP_CD, TRAN_SEQ, APV_NO)
		SELECT #{tranId, jdbcType=VARCHAR} TRAN_ID, 'trx' TRAN_DATA_TYP_CD, ${rnumSql} RNUM, TRX_APV_NO
		FROM AP_ONGD_TRX_D TRX
		WHERE ORGN_APV_NO IN (
			SELECT APV_NO
			FROM AP_TRAN_TGT_T
			WHERE TRAN_ID = #{tranId, jdbcType=VARCHAR} AND TRAN_DATA_TYP_CD = 'doc'
		)
		ORDER BY TRX_APV_NO
	</insert>
	
	<!-- 3. 데이터 이관 -->
	<insert id="copyTransferingData" parameterType="ApxTranVo">
		/* com.innobiz.orange.web.ap.dao.ApxTranDao.copyTransferingData */<![CDATA[
		INSERT INTO ${tgtTbl}
		SELECT * 
		FROM ${srcTbl}
		WHERE ${keyCol} IN (
			SELECT APV_NO
			FROM AP_TRAN_TGT_T
			WHERE TRAN_ID = #{tranId, jdbcType=VARCHAR}
				AND TRAN_DATA_TYP_CD = #{tranDataTypCd, jdbcType=VARCHAR}
				AND TRAN_SEQ > #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}
				AND TRAN_SEQ <= (#{pageNo, jdbcType=NUMERIC} + 1) * #{pageRowCnt, jdbcType=NUMERIC}
		)
		ORDER BY ${orderBy}]]>
	</insert>
	
	<!-- 5. 이관 문서 저장소 변경 : 삭제 -->
	<delete id="deleteStorageOfData" parameterType="ApxTranVo">
		/* com.innobiz.orange.web.ap.dao.ApxTranDao.deleteStorageOfData */<![CDATA[
		DELETE FROM AP_STOR_R WHERE APV_NO IN (
			SELECT APV_NO
			FROM AP_TRAN_TGT_T
			WHERE TRAN_ID = #{tranId, jdbcType=VARCHAR}
				AND TRAN_DATA_TYP_CD = #{tranDataTypCd, jdbcType=VARCHAR}
				AND TRAN_SEQ > #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}
				AND TRAN_SEQ <= (#{pageNo, jdbcType=NUMERIC} + 1) * #{pageRowCnt, jdbcType=NUMERIC}
		)]]>
	</delete>
	<!-- 5. 이관 문서 저장소 변경 : 입력 -->
	<insert id="insertStorageOfData" parameterType="ApxTranVo">
		/* com.innobiz.orange.web.ap.dao.ApxTranDao.insertStorageOfData */<![CDATA[
		INSERT INTO AP_STOR_R (APV_NO, STOR_ID)
		SELECT APV_NO, #{storId, jdbcType=VARCHAR} STOR_ID
		FROM AP_TRAN_TGT_T
		WHERE TRAN_ID = #{tranId, jdbcType=VARCHAR}
			AND TRAN_DATA_TYP_CD = #{tranDataTypCd, jdbcType=VARCHAR}
			AND TRAN_SEQ > #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}
			AND TRAN_SEQ <= (#{pageNo, jdbcType=NUMERIC} + 1) * #{pageRowCnt, jdbcType=NUMERIC}]]>
	</insert>
	
	<!-- 6. 이관된 데이터 삭제 -->
	<insert id="deleteTransferedData" parameterType="ApxTranVo">
		/* com.innobiz.orange.web.ap.dao.ApxTranDao.deleteTransferedData */<![CDATA[
		DELETE FROM ${srcTbl}
		WHERE ${keyCol} IN (
			SELECT APV_NO
			FROM AP_TRAN_TGT_T
			WHERE TRAN_ID = #{tranId, jdbcType=VARCHAR}
				AND TRAN_DATA_TYP_CD = #{tranDataTypCd, jdbcType=VARCHAR}
				AND TRAN_SEQ > #{pageNo, jdbcType=NUMERIC} * #{pageRowCnt, jdbcType=NUMERIC}
				AND TRAN_SEQ <= (#{pageNo, jdbcType=NUMERIC} + 1) * #{pageRowCnt, jdbcType=NUMERIC}
		)]]>
	</insert>
	 
	<!-- 7. 데이터 조각 모음 / MSSQL -->
	<update id="processDefragmentationForMSSQL" parameterType="ApxTranVo">
		/* com.innobiz.orange.web.ap.dao.ApxTranDao.processDefragmentationForMSSQL */
		ALTER INDEX ALL ON ${srcTbl} REBUILD WITH (PAD_INDEX = ON, FILLFACTOR = 90)
	</update>
	
	<!-- 7. 데이터 조각 모음 / ORACLE -->
	<update id="processDefragmentationForORACLE" parameterType="ApxTranVo">
		/* com.innobiz.orange.web.ap.dao.ApxTranDao.processDefragmentationForORACLE */<if
	test="sqlSeq == 1">
		ALTER TABLE ${srcTbl} NOLOGGING</if><if
	test="sqlSeq == 2">
		ALTER INDEX ${idxNm} NOLOGGING</if><if
	test="sqlSeq == 3">
		ALTER TABLE ${srcTbl} ENABLE ROW MOVEMENT</if><if
	test="sqlSeq == 4">
		ALTER TABLE ${srcTbl} SHRINK SPACE CASCADE</if><if
	test="sqlSeq == 5">
		ALTER TABLE ${srcTbl} DISABLE ROW MOVEMENT</if><if
	test="sqlSeq == 6">
		ALTER INDEX ${idxNm} LOGGING</if><if
	test="sqlSeq == 7">
		ALTER TABLE ${srcTbl} LOGGING</if>
	</update>
	
	<!-- 테이블의 인덱스 조회 -->
	<select id="queryIndexForORACLE" parameterType="ApxTranVo" resultType="String">
		/* com.innobiz.orange.web.ap.dao.ApxTranDao.queryIndexForORACLE */
		SELECT INDEX_NAME FROM USER_INDEXES WHERE TABLE_NAME = #{srcTbl, jdbcType=VARCHAR}
	</select>
	
	<select id="queryMaxTranProcSeq" parameterType="ApxTranVo" resultType="Integer">
		/* com.innobiz.orange.web.ap.dao.ApxTranDao.queryMaxTranProcSeq */
		SELECT MAX(SEQ) SEQ FROM AP_TRAN_PROC_L WHERE TRAN_ID = #{tranId, jdbcType=VARCHAR}
	</select>

</mapper>