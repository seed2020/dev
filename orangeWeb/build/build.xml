<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="mk-jar" name="groupware"
	xmlns:artifact="antlib:org.apache.maven.artifact.ant">

	<!-- [고객코드]에 따라 설정함 -->
	<property description="프로퍼티 파일 : build_[고객코드].properties - 개발서버 : ABC123"
		file="build.properties" />
	
	<typedef description="artifact: Ant에서 Maven 사용 라이브러리"
		resource="org/apache/maven/artifact/ant/antlib.xml"
		uri="antlib:org.apache.maven.artifact.ant"
		classpath="lib/maven-ant-tasks-2.1.3.jar" />

	<typedef description="contrib: Ant에서 if/then/else 사용 라이브러리"
		resource="net/sf/antcontrib/antlib.xml"
		classpath="lib/ant-contrib-1.0b3.jar" />
	
	<target description="작업 디렉토리 지우기"
		name="del-old">
		<delete dir="${web.output}/webapp" />
		<delete file="${web.output}/${cust.code}/webapp.jar" />
		<delete file="${web.output}/${cust.code}/htdocs.jar" />
		<mkdir dir="${web.output}/webapp/WEB-INF" />
	</target>

	<target  description="WIN-INF 디렉토리 output 디렉토리로 복사"
		name="cp-web-inf">
		<copy todir="${web.output}/webapp/WEB-INF" overwrite="true">
			<fileset dir="${web.source}/WEB-INF">
				<exclude name="lib/**" />
				<exclude name="jsp/sample/**" />
				<exclude name="message/message-temp_ko_KR.properties" />
			</fileset>
		</copy>
	</target>

	<target description="classes 디렉토리 output 디렉토리로 복사"
		name="cp-classes">
		<copy todir="${web.output}/webapp/WEB-INF/classes" overwrite="true">
			<fileset dir="${web.target}/classes">
				<include name="com/**/*.*" />
				<include name="spring/*.*" />
				<include name="dtd/*.*" />
				<include name="resources/**/*.*" />
				<include name="sql/${sql.dbms}/**/*.*" />
				<include name="sql/mybatis-config.xml" />
				<exclude name="com/innobiz/orange/web/cm/crypto/PropertyEncUtil.class" />
				<exclude name="com/innobiz/orange/web/zzz/*.*" />
				<exclude name="com/innobiz/orange/web/sample/**/*.*" />
			</fileset>
		</copy>
		
		<copy overwrite="true"
				file="${web.target}/classes/settings/${cust.code}/gwOrange.license"
				tofile="${web.output}/webapp/WEB-INF/classes/gwOrange.license" />
		<copy overwrite="true"
				file="${web.target}/classes/settings/${cust.code}/context.properties"
				tofile="${web.output}/webapp/WEB-INF/classes/context.properties" />
		
		<if>
			<available file="${web.target}/classes/settings/${cust.code}/servlet-context.xml"/>
			<then>
				<copy overwrite="true"
					file="${web.target}/classes/settings/${cust.code}/servlet-context.xml"
					tofile="${web.output}/webapp/WEB-INF/classes/spring/servlet-context.xml" />
			</then>
			<else>
				<copy overwrite="true"
					file="${web.target}/classes/deploy/servlet-context.xml"
					tofile="${web.output}/webapp/WEB-INF/classes/spring/servlet-context.xml" />
			</else>
		</if>
		
		<if>
			<available file="${web.target}/classes/settings/${cust.code}/transaction-context.xml"/>
			<then>
				<copy overwrite="true"
					file="${web.target}/classes/settings/${cust.code}/transaction-context.xml"
					tofile="${web.output}/webapp/WEB-INF/classes/spring/transaction-context.xml" />
			</then>
			<else>
				<copy overwrite="true"
					file="${web.target}/classes/deploy/transaction-context.xml"
					tofile="${web.output}/webapp/WEB-INF/classes/spring/transaction-context.xml" />
			</else>
		</if>
		
		<if>
			<available file="${web.target}/classes/settings/${cust.code}/log4j.xml"/>
			<then>
				<copy overwrite="true"
					file="${web.target}/classes/settings/${cust.code}/log4j.xml"
					tofile="${web.output}/webapp/WEB-INF/classes/log4j.xml" />
			</then>
			<else>
				<copy overwrite="true"
					file="${web.target}/classes/deploy/log4j.xml"
					tofile="${web.output}/webapp/WEB-INF/classes/log4j.xml" />
			</else>
		</if>
		
		<if>
			<available file="${web.target}/classes/settings/${cust.code}/web.xml"/>
			<then>
				<copy overwrite="true"
					file="${web.target}/classes/settings/${cust.code}/web.xml"
					tofile="${web.output}/webapp/WEB-INF/web.xml" />
			</then>
		</if>
	</target>
	
	<target description="Maven Dependency 라이브러리 복사"
		name="cp-maven-libs">
		
		<artifact:dependencies
			filesetId="dependency.fileset" useScope="runtime" description="">
			<artifact:pom id="mypom" file="../pom.xml" />
		</artifact:dependencies>
		
		<copy description="Dependency의 라이브러리 복사"
			todir="${web.output}/webapp/WEB-INF/lib">
	    	<fileset refid="dependency.fileset"/>
			<mapper type="flatten" />
		</copy>
		
	</target>
	
	<target description="jar 파일 생성 "
		name="mk-jar" depends="del-old,cp-web-inf,cp-classes,cp-maven-libs">
		
		<jar description="WAS 용 배포 jar 만들기 - Output Directory 에서"
			destfile="${web.output}/${cust.code}/webapp.jar">
			<tarfileset dir="${web.output}/webapp">
				<include name="/WEB-INF/**/*.*" />
			</tarfileset>
		</jar>
		
		<jar description="WEB 용 소배포 jar 만들기 - 실제 Directory 에서 추출"
			destfile="${web.output}/${cust.code}/htdocs.jar">
			<tarfileset dir="${web.source}">
				<include name="css/**/*.*" />
				<include name="editor/jelly/*.*" />
				<include name="images/**/*.*" />
				<include name="js/**/*.*" />
				<include name="browserconfig.xml" />
				<include name="favicon.ico" />
				<exclude name="images/upload/**/*.*" />
				<exclude name="editor/jelly/jellyEditor.1.0.js" />
				<exclude name="editor/jelly/test.html" />
				<exclude name="js/calendar/fullcalendar.js" />
				<exclude name="js/dom2img.js" />
				<exclude name="js/colorpicker/spectrum.js" />
				<exclude name="js/jquery-calx-2.2.7.js" />
				<exclude name="js/screenshot/html2canvas.js" />
			</tarfileset>
		</jar>
		
		<echo message="${web.output}/${cust.code} 에 htdocs.jar, webapp.jar 생성함" />
		
		<!--
		<if>
			<equals arg1="${cust.code}" arg2="ABC123" />
			<then>
				<copy description="배포 네트웍 드라이버로 복사"
					todir="${result.dir}" overwrite="true">
					<fileset dir="${web.output}/${cust.code}">
						<include name="*.jar" />
					</fileset>
				</copy>
				<echo message="개발서버에 jar 복사" />
			</then>
			<else>
				
			</else>
		</if>
		-->
	</target>

</project>